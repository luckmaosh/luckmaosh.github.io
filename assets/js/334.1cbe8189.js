(window.webpackJsonp=window.webpackJsonp||[]).push([[334],{1611:function(t,n,s){"use strict";s.r(n);var e=s(5),a=Object(e.a)({},(function(){var t=this,n=t._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"_178-商品详情页动态渲染系统-高可用架构优化之读链路多级降级思路介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_178-商品详情页动态渲染系统-高可用架构优化之读链路多级降级思路介绍"}},[t._v("#")]),t._v(" 178. 商品详情页动态渲染系统：高可用架构优化之读链路多级降级思路介绍")]),t._v(" "),n("p",[t._v("本章节也只是思路介绍，脚本也会有示例。")]),t._v(" "),n("p",[t._v("读链路：nginx local cache -> 本机房 redis 从集群 -> 数据直连服务的 jvm 堆缓存（之前讲解，这次没做） -> 其他机房 redis 主集群 -> 依赖服务")]),t._v(" "),n("p",[t._v("这里最有可能出现问题的就是：redis 从集群、 数据直连服务、redis 主集群。\n如果这三个都挂了，在读链路上来看，也是灾难性的了，依赖服务很有可能被干死嘛。")]),t._v(" "),n("p",[t._v("那么针对这三个出问题的地方进行降级处理，思路如下脚本，当访问失败时做标记，失败一定次数就标记为挂掉，\n在一定时间内就不再提供服务或访问降级策略（降级策略都失败就不再提供服务）。\n其实这里做的功能就是之前 hystrix 中的熔断器类似的功能。")]),t._v(" "),n("p",[t._v("这个思路是没有问题，唯一的问题就是对于计数处理等场景，如：下面先从缓存获取失败次数，然后加 1，再更新到缓存中，\n这种操作方式不会有数据竞争问题导致脏数据吗？还是说在这种高并发的场景下，脏一点无关紧要？")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('local cjson = require("cjson")\nlocal http = require("resty.http")\nlocal redis = require("resty.redis")  \n\nlocal function close_redis(red)  \n\tif not red then  \n\t\t\treturn  \n\tend  \n\tlocal pool_max_idle_time = 10000\n\tlocal pool_size = 100\n\tlocal ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  \n\tif not ok then  \n\t\t\tngx.say("set keepalive error : ", err)  \n\tend  \nend\n\nlocal uri_args = ngx.req.get_uri_args()\nlocal productId = uri_args["productId"]\n\nlocal cache_ngx = ngx.shared.my_cache\nlocal productCacheKey = "product_"..productId\nlocal productCache = cache_ngx:get(productCacheKey)\n\nif productCache == "" or productCache == nil then\n  local slaveRedisDegrade = cache_ngx:get("slaveRedisDegrade")\n  -- redis 从集群是否挂掉  \n  if slaveRedisDegrade == "true" then\n        local dataLinkDegrade = cache_ngx:get("dataLinkDegrade")\n\t\t-- 数据直连服务是否挂掉\n\t\tif dataLinkDegrade == true then\n\t\t\t  local red = redis:new()  \n\t\t\t  red:set_timeout(1000)  \n\t\t\t  local ip = "192.168.31.223"  \n\t\t\t  local port = 1111  \n\t\t\t  local ok, err = red:connect(ip, port)\n\t\t\t  local redisResp, redisErr = red:get("dim_product_"..productId)\n\t\t\t  productCache = redisResp\n\n\t\t\t    local curTime = os.time()\n\t\t\t\tlocal diffTime = os.difftime(curTime, cache_ngx:get("startdataLinkDegradeTime"))\n\t\t\t\t// 当挂掉时间超过 60 秒的时候，再次尝试从数据直连服务获取数据\n\t\t\t\tif diffTime > 60 then\n\t\t\t\t    local httpc = http.new()\n\t\t\t\t\tlocal resp, err = httpc:request_uri("http://192.168.31.179:8767",{\n\t\t\t\t\t  method = "GET",\n\t\t\t\t\t  path = "/product?productId="..productId\n\t\t\t\t\t})\n\n\t\t\t\t    if resp then\n\t\t\t\t      cache_ngx:set("dataLinkDegrade", "false")\n\t\t\t\t    end\n\t\t\t\tend\n\t\telse\n\t\t\tlocal httpc = http.new()\n\t\t\tlocal resp, err = httpc:request_uri("http://192.168.31.179:8767",{\n\t\t\t  method = "GET",\n\t\t\t  path = "/product?productId="..productId\n\t\t\t})\n\t\t\t-- 当从数据直连服务访问不到数据时，就计数\n\t\t\tif not resp then  \n\t\t\t\tngx.say("request error :", err)  \n\n\t\t\t\tlocal dataLinkFailureCnt = cache_ngx:get("dataLinkFailureCnt")\n\t\t\t\tcache_ngx:set("dataLinkFailureCnt", dataLinkFailureCnt + 1)\n\t\t\t\t-- 当数据直连服务访问失败到达 10 次时，就标记为数据直连服务已经挂掉了\n\t\t\t\tif dataLinkFailureCnt > 10 then\n\t\t\t\t  cache_ngx:set("dataLinkDegrade", "true")\n\t\t\t\t  cache_ngx:set("startDataLinkDegradeTime", os.time())\n\t\t\t\tend\n\t\t\tend\n\n\t\t\tproductCache = resp.body\n\n\t\t\tlocal curTime = os.time()\n\t\t\tlocal diffTime = os.difftime(curTime, cache_ngx:get("startSlaveRedisDegradeTime"))\n\n\t\t\tif diffTime > 60 then\n\t\t\t  local red = redis:new()  \n\t\t\t  red:set_timeout(1000)  \n\t\t\t  local ip = "192.168.31.223"  \n\t\t\t  local port = 1112  \n\t\t\t  local ok, err = red:connect(ip, port)  \n\n\t\t\t  if ok then\n\t\t\t\tcache_ngx:set("slaveRedisDegrade", "false")\n\t\t\t  end\n\t\t\tend\n\t\tend\n  else\n\t  local red = redis:new()  \n\t  red:set_timeout(1000)  \n\t  local ip = "192.168.31.223"  \n\t  local port = 1112  \n\t  local ok, err = red:connect(ip, port)  \n\n\t  if not ok then  \n\t\tngx.say("connect to redis error : ", err)  \n\n\t\tlocal slaveRedisFailureCnt = cache_ngx:get("slaveRedisFailureCnt")\n\t\tcache_ngx:set("slaveRedisFailureCnt", slaveRedisFailureCnt + 1)\n\n\t\tif slaveRedisFailureCnt > 10 then\n\t\t  cache_ngx:set("slaveRedisDegrade", "true")\n\t\t  cache_ngx:set("startSlaveRedisDegradeTime", os.time())\n\t\tend\n\n\t\treturn close_redis(red)  \n\t  end\n\n\t  local redisResp, redisErr = red:get("dim_product_"..productId)\n\n\t  if redisResp == ngx.null or redisResp == "" or redisResp == nil then  \n\t    local dataLinkDegrade = cache_ngx:get("dataLinkDegrade")\n\n\t\tif dataLinkDegrade == "true" then\n\t\t\t  local red = redis:new()  \n\t\t\t  red:set_timeout(1000)  \n\t\t\t  local ip = "192.168.31.223"  \n\t\t\t  local port = 1111  \n\t\t\t  local ok, err = red:connect(ip, port)\n\t\t\t  local redisResp, redisErr = red:get("dim_product_"..productId)\n\t\t\t  productCache = redisResp\n\n\t\t\t  local curTime = os.time()\n\t\t\t\tlocal diffTime = os.difftime(curTime, cache_ngx:get("startdataLinkDegradeTime"))\n\n\t\t\t\tif diffTime > 60 then\n\t\t\t\t    local httpc = http.new()\n\t\t\t\t\tlocal resp, err = httpc:request_uri("http://192.168.31.179:8767",{\n\t\t\t\t\t  method = "GET",\n\t\t\t\t\t  path = "/product?productId="..productId\n\t\t\t\t\t})\n\n\t\t\t\t    if resp then\n\t\t\t\t      cache_ngx:set("dataLinkDegrade", "false")\n\t\t\t\t    end\n\t\t\t\tend\n\t\telse\n\t\t\tlocal httpc = http.new()\n\t\t\tlocal resp, err = httpc:request_uri("http://192.168.31.179:8767",{\n\t\t\t  method = "GET",\n\t\t\t  path = "/product?productId="..productId\n\t\t\t})\n\n\t\t\tif not resp then  \n\t\t\t\tngx.say("request error :", err)  \n\n\t\t\t\tlocal dataLinkFailureCnt = cache_ngx:get("dataLinkFailureCnt")\n\t\t\t\tcache_ngx:set("dataLinkFailureCnt", dataLinkFailureCnt + 1)\n\n\t\t\t\tif dataLinkFailureCnt > 10 then\n\t\t\t\t  cache_ngx:set("dataLinkDegrade", "true")\n\t\t\t\t  cache_ngx:set("startDataLinkDegradeTime", os.time())\n\t\t\t\tend\n\t\t\tend\n\n\t\t\tproductCache = resp.body\n\t\tend\n\t  else\n\t\tproductCache = redisResp\n\t  end\n  end\n\n  math.randomseed(tostring(os.time()):reverse():sub(1, 7))\n  local expireTime = math.random(600, 1200)  \n\n  cache_ngx:set(productCacheKey, productCache, expireTime)\nend\n\nlocal context = {\n  productInfo = productCache,\n}\n\nlocal template = require("resty.template")\ntemplate.render("product.html", context)\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br"),n("span",{staticClass:"line-number"},[t._v("43")]),n("br"),n("span",{staticClass:"line-number"},[t._v("44")]),n("br"),n("span",{staticClass:"line-number"},[t._v("45")]),n("br"),n("span",{staticClass:"line-number"},[t._v("46")]),n("br"),n("span",{staticClass:"line-number"},[t._v("47")]),n("br"),n("span",{staticClass:"line-number"},[t._v("48")]),n("br"),n("span",{staticClass:"line-number"},[t._v("49")]),n("br"),n("span",{staticClass:"line-number"},[t._v("50")]),n("br"),n("span",{staticClass:"line-number"},[t._v("51")]),n("br"),n("span",{staticClass:"line-number"},[t._v("52")]),n("br"),n("span",{staticClass:"line-number"},[t._v("53")]),n("br"),n("span",{staticClass:"line-number"},[t._v("54")]),n("br"),n("span",{staticClass:"line-number"},[t._v("55")]),n("br"),n("span",{staticClass:"line-number"},[t._v("56")]),n("br"),n("span",{staticClass:"line-number"},[t._v("57")]),n("br"),n("span",{staticClass:"line-number"},[t._v("58")]),n("br"),n("span",{staticClass:"line-number"},[t._v("59")]),n("br"),n("span",{staticClass:"line-number"},[t._v("60")]),n("br"),n("span",{staticClass:"line-number"},[t._v("61")]),n("br"),n("span",{staticClass:"line-number"},[t._v("62")]),n("br"),n("span",{staticClass:"line-number"},[t._v("63")]),n("br"),n("span",{staticClass:"line-number"},[t._v("64")]),n("br"),n("span",{staticClass:"line-number"},[t._v("65")]),n("br"),n("span",{staticClass:"line-number"},[t._v("66")]),n("br"),n("span",{staticClass:"line-number"},[t._v("67")]),n("br"),n("span",{staticClass:"line-number"},[t._v("68")]),n("br"),n("span",{staticClass:"line-number"},[t._v("69")]),n("br"),n("span",{staticClass:"line-number"},[t._v("70")]),n("br"),n("span",{staticClass:"line-number"},[t._v("71")]),n("br"),n("span",{staticClass:"line-number"},[t._v("72")]),n("br"),n("span",{staticClass:"line-number"},[t._v("73")]),n("br"),n("span",{staticClass:"line-number"},[t._v("74")]),n("br"),n("span",{staticClass:"line-number"},[t._v("75")]),n("br"),n("span",{staticClass:"line-number"},[t._v("76")]),n("br"),n("span",{staticClass:"line-number"},[t._v("77")]),n("br"),n("span",{staticClass:"line-number"},[t._v("78")]),n("br"),n("span",{staticClass:"line-number"},[t._v("79")]),n("br"),n("span",{staticClass:"line-number"},[t._v("80")]),n("br"),n("span",{staticClass:"line-number"},[t._v("81")]),n("br"),n("span",{staticClass:"line-number"},[t._v("82")]),n("br"),n("span",{staticClass:"line-number"},[t._v("83")]),n("br"),n("span",{staticClass:"line-number"},[t._v("84")]),n("br"),n("span",{staticClass:"line-number"},[t._v("85")]),n("br"),n("span",{staticClass:"line-number"},[t._v("86")]),n("br"),n("span",{staticClass:"line-number"},[t._v("87")]),n("br"),n("span",{staticClass:"line-number"},[t._v("88")]),n("br"),n("span",{staticClass:"line-number"},[t._v("89")]),n("br"),n("span",{staticClass:"line-number"},[t._v("90")]),n("br"),n("span",{staticClass:"line-number"},[t._v("91")]),n("br"),n("span",{staticClass:"line-number"},[t._v("92")]),n("br"),n("span",{staticClass:"line-number"},[t._v("93")]),n("br"),n("span",{staticClass:"line-number"},[t._v("94")]),n("br"),n("span",{staticClass:"line-number"},[t._v("95")]),n("br"),n("span",{staticClass:"line-number"},[t._v("96")]),n("br"),n("span",{staticClass:"line-number"},[t._v("97")]),n("br"),n("span",{staticClass:"line-number"},[t._v("98")]),n("br"),n("span",{staticClass:"line-number"},[t._v("99")]),n("br"),n("span",{staticClass:"line-number"},[t._v("100")]),n("br"),n("span",{staticClass:"line-number"},[t._v("101")]),n("br"),n("span",{staticClass:"line-number"},[t._v("102")]),n("br"),n("span",{staticClass:"line-number"},[t._v("103")]),n("br"),n("span",{staticClass:"line-number"},[t._v("104")]),n("br"),n("span",{staticClass:"line-number"},[t._v("105")]),n("br"),n("span",{staticClass:"line-number"},[t._v("106")]),n("br"),n("span",{staticClass:"line-number"},[t._v("107")]),n("br"),n("span",{staticClass:"line-number"},[t._v("108")]),n("br"),n("span",{staticClass:"line-number"},[t._v("109")]),n("br"),n("span",{staticClass:"line-number"},[t._v("110")]),n("br"),n("span",{staticClass:"line-number"},[t._v("111")]),n("br"),n("span",{staticClass:"line-number"},[t._v("112")]),n("br"),n("span",{staticClass:"line-number"},[t._v("113")]),n("br"),n("span",{staticClass:"line-number"},[t._v("114")]),n("br"),n("span",{staticClass:"line-number"},[t._v("115")]),n("br"),n("span",{staticClass:"line-number"},[t._v("116")]),n("br"),n("span",{staticClass:"line-number"},[t._v("117")]),n("br"),n("span",{staticClass:"line-number"},[t._v("118")]),n("br"),n("span",{staticClass:"line-number"},[t._v("119")]),n("br"),n("span",{staticClass:"line-number"},[t._v("120")]),n("br"),n("span",{staticClass:"line-number"},[t._v("121")]),n("br"),n("span",{staticClass:"line-number"},[t._v("122")]),n("br"),n("span",{staticClass:"line-number"},[t._v("123")]),n("br"),n("span",{staticClass:"line-number"},[t._v("124")]),n("br"),n("span",{staticClass:"line-number"},[t._v("125")]),n("br"),n("span",{staticClass:"line-number"},[t._v("126")]),n("br"),n("span",{staticClass:"line-number"},[t._v("127")]),n("br"),n("span",{staticClass:"line-number"},[t._v("128")]),n("br"),n("span",{staticClass:"line-number"},[t._v("129")]),n("br"),n("span",{staticClass:"line-number"},[t._v("130")]),n("br"),n("span",{staticClass:"line-number"},[t._v("131")]),n("br"),n("span",{staticClass:"line-number"},[t._v("132")]),n("br"),n("span",{staticClass:"line-number"},[t._v("133")]),n("br"),n("span",{staticClass:"line-number"},[t._v("134")]),n("br"),n("span",{staticClass:"line-number"},[t._v("135")]),n("br"),n("span",{staticClass:"line-number"},[t._v("136")]),n("br"),n("span",{staticClass:"line-number"},[t._v("137")]),n("br"),n("span",{staticClass:"line-number"},[t._v("138")]),n("br"),n("span",{staticClass:"line-number"},[t._v("139")]),n("br"),n("span",{staticClass:"line-number"},[t._v("140")]),n("br"),n("span",{staticClass:"line-number"},[t._v("141")]),n("br"),n("span",{staticClass:"line-number"},[t._v("142")]),n("br"),n("span",{staticClass:"line-number"},[t._v("143")]),n("br"),n("span",{staticClass:"line-number"},[t._v("144")]),n("br"),n("span",{staticClass:"line-number"},[t._v("145")]),n("br"),n("span",{staticClass:"line-number"},[t._v("146")]),n("br"),n("span",{staticClass:"line-number"},[t._v("147")]),n("br"),n("span",{staticClass:"line-number"},[t._v("148")]),n("br"),n("span",{staticClass:"line-number"},[t._v("149")]),n("br"),n("span",{staticClass:"line-number"},[t._v("150")]),n("br"),n("span",{staticClass:"line-number"},[t._v("151")]),n("br"),n("span",{staticClass:"line-number"},[t._v("152")]),n("br"),n("span",{staticClass:"line-number"},[t._v("153")]),n("br"),n("span",{staticClass:"line-number"},[t._v("154")]),n("br"),n("span",{staticClass:"line-number"},[t._v("155")]),n("br"),n("span",{staticClass:"line-number"},[t._v("156")]),n("br"),n("span",{staticClass:"line-number"},[t._v("157")]),n("br"),n("span",{staticClass:"line-number"},[t._v("158")]),n("br"),n("span",{staticClass:"line-number"},[t._v("159")]),n("br"),n("span",{staticClass:"line-number"},[t._v("160")]),n("br"),n("span",{staticClass:"line-number"},[t._v("161")]),n("br"),n("span",{staticClass:"line-number"},[t._v("162")]),n("br"),n("span",{staticClass:"line-number"},[t._v("163")]),n("br"),n("span",{staticClass:"line-number"},[t._v("164")]),n("br"),n("span",{staticClass:"line-number"},[t._v("165")]),n("br"),n("span",{staticClass:"line-number"},[t._v("166")]),n("br"),n("span",{staticClass:"line-number"},[t._v("167")]),n("br"),n("span",{staticClass:"line-number"},[t._v("168")]),n("br"),n("span",{staticClass:"line-number"},[t._v("169")]),n("br"),n("span",{staticClass:"line-number"},[t._v("170")]),n("br"),n("span",{staticClass:"line-number"},[t._v("171")]),n("br"),n("span",{staticClass:"line-number"},[t._v("172")]),n("br"),n("span",{staticClass:"line-number"},[t._v("173")]),n("br"),n("span",{staticClass:"line-number"},[t._v("174")]),n("br"),n("span",{staticClass:"line-number"},[t._v("175")]),n("br")])])])}),[],!1,null,null,null);n.default=a.exports}}]);