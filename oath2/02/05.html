<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实战案例：使用 Spring Security 搭建一套基于 JWT 的 OAuth 2.0 架构 | Home</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="用来记录工作和学习过程中的笔记，汇总成册方便查阅，类容涵盖各类技术，如：Java、Git、ElasticSearch、MyCat、设计模式、Gradle、Vue">
    
    <link rel="preload" href="/assets/css/0.styles.0806f82e.css" as="style"><link rel="preload" href="/assets/js/app.eb56791c.js" as="script"><link rel="preload" href="/assets/js/10.7dba176e.js" as="script"><link rel="preload" href="/assets/js/22.2be2201a.js" as="script"><link rel="preload" href="/assets/js/104.257f0ce6.js" as="script"><link rel="prefetch" href="/assets/js/100.0de1b0cb.js"><link rel="prefetch" href="/assets/js/101.7236a5b2.js"><link rel="prefetch" href="/assets/js/102.6de1bcaa.js"><link rel="prefetch" href="/assets/js/103.61ea69f8.js"><link rel="prefetch" href="/assets/js/105.93715199.js"><link rel="prefetch" href="/assets/js/106.0b345c95.js"><link rel="prefetch" href="/assets/js/107.482fa618.js"><link rel="prefetch" href="/assets/js/108.a046ccb7.js"><link rel="prefetch" href="/assets/js/109.a3806632.js"><link rel="prefetch" href="/assets/js/11.449c5b6b.js"><link rel="prefetch" href="/assets/js/110.9d38e7f4.js"><link rel="prefetch" href="/assets/js/111.de7ddbd4.js"><link rel="prefetch" href="/assets/js/112.67e9fc8e.js"><link rel="prefetch" href="/assets/js/113.806e6abb.js"><link rel="prefetch" href="/assets/js/114.c6c20c4c.js"><link rel="prefetch" href="/assets/js/115.225e711e.js"><link rel="prefetch" href="/assets/js/116.e89ad44b.js"><link rel="prefetch" href="/assets/js/117.7c7a6d26.js"><link rel="prefetch" href="/assets/js/118.79bb5650.js"><link rel="prefetch" href="/assets/js/119.bb2af6e0.js"><link rel="prefetch" href="/assets/js/12.73d09f43.js"><link rel="prefetch" href="/assets/js/120.3b28aced.js"><link rel="prefetch" href="/assets/js/121.415e1dc8.js"><link rel="prefetch" href="/assets/js/122.2e5a215d.js"><link rel="prefetch" href="/assets/js/123.5f410334.js"><link rel="prefetch" href="/assets/js/124.c1825af2.js"><link rel="prefetch" href="/assets/js/125.005209f5.js"><link rel="prefetch" href="/assets/js/126.3477c913.js"><link rel="prefetch" href="/assets/js/127.51c00473.js"><link rel="prefetch" href="/assets/js/128.cb4f4919.js"><link rel="prefetch" href="/assets/js/129.622c1a57.js"><link rel="prefetch" href="/assets/js/13.da011a72.js"><link rel="prefetch" href="/assets/js/130.0dcb02da.js"><link rel="prefetch" href="/assets/js/131.082a658f.js"><link rel="prefetch" href="/assets/js/132.499161f0.js"><link rel="prefetch" href="/assets/js/133.552e8312.js"><link rel="prefetch" href="/assets/js/134.bdc891ca.js"><link rel="prefetch" href="/assets/js/135.489ff600.js"><link rel="prefetch" href="/assets/js/136.979ebbe2.js"><link rel="prefetch" href="/assets/js/137.662d134a.js"><link rel="prefetch" href="/assets/js/138.c3dcffe2.js"><link rel="prefetch" href="/assets/js/139.b75dd62c.js"><link rel="prefetch" href="/assets/js/14.bca67312.js"><link rel="prefetch" href="/assets/js/140.3204bb77.js"><link rel="prefetch" href="/assets/js/141.df4a6315.js"><link rel="prefetch" href="/assets/js/142.7e60df5b.js"><link rel="prefetch" href="/assets/js/143.dd582b3b.js"><link rel="prefetch" href="/assets/js/144.35e32cab.js"><link rel="prefetch" href="/assets/js/145.15790517.js"><link rel="prefetch" href="/assets/js/146.6471d93b.js"><link rel="prefetch" href="/assets/js/147.e3995a1d.js"><link rel="prefetch" href="/assets/js/148.4cfdb13e.js"><link rel="prefetch" href="/assets/js/149.8971b9b4.js"><link rel="prefetch" href="/assets/js/15.9b002b6a.js"><link rel="prefetch" href="/assets/js/150.f8814a5d.js"><link rel="prefetch" href="/assets/js/151.15b9cc26.js"><link rel="prefetch" href="/assets/js/152.2f3f7b76.js"><link rel="prefetch" href="/assets/js/153.ba7794be.js"><link rel="prefetch" href="/assets/js/154.d2736f68.js"><link rel="prefetch" href="/assets/js/155.1de6cae9.js"><link rel="prefetch" href="/assets/js/156.3fce4e4a.js"><link rel="prefetch" href="/assets/js/157.3cf5211b.js"><link rel="prefetch" href="/assets/js/158.fa590522.js"><link rel="prefetch" href="/assets/js/159.22c5af5d.js"><link rel="prefetch" href="/assets/js/16.d414a1d4.js"><link rel="prefetch" href="/assets/js/160.fd2348a0.js"><link rel="prefetch" href="/assets/js/161.3b472ae8.js"><link rel="prefetch" href="/assets/js/162.28d8e258.js"><link rel="prefetch" href="/assets/js/163.04c48af5.js"><link rel="prefetch" href="/assets/js/164.dd3272a8.js"><link rel="prefetch" href="/assets/js/165.833cad5a.js"><link rel="prefetch" href="/assets/js/166.d01c5b6f.js"><link rel="prefetch" href="/assets/js/167.0a2e4643.js"><link rel="prefetch" href="/assets/js/168.99635730.js"><link rel="prefetch" href="/assets/js/169.af554802.js"><link rel="prefetch" href="/assets/js/17.bfc5f0b1.js"><link rel="prefetch" href="/assets/js/170.3bd6e634.js"><link rel="prefetch" href="/assets/js/171.b6a44a15.js"><link rel="prefetch" href="/assets/js/172.5ec51425.js"><link rel="prefetch" href="/assets/js/173.04e45e87.js"><link rel="prefetch" href="/assets/js/174.b5500c46.js"><link rel="prefetch" href="/assets/js/175.cb0aeaf3.js"><link rel="prefetch" href="/assets/js/176.4f3a56f5.js"><link rel="prefetch" href="/assets/js/177.e9825e9a.js"><link rel="prefetch" href="/assets/js/178.cc4eb2d7.js"><link rel="prefetch" href="/assets/js/179.d0b177d1.js"><link rel="prefetch" href="/assets/js/18.4c564806.js"><link rel="prefetch" href="/assets/js/180.7fce6444.js"><link rel="prefetch" href="/assets/js/181.3aae0503.js"><link rel="prefetch" href="/assets/js/182.33ca1c85.js"><link rel="prefetch" href="/assets/js/183.7fa79523.js"><link rel="prefetch" href="/assets/js/184.18004e22.js"><link rel="prefetch" href="/assets/js/185.67a8bda4.js"><link rel="prefetch" href="/assets/js/186.0a45b021.js"><link rel="prefetch" href="/assets/js/187.30689325.js"><link rel="prefetch" href="/assets/js/188.69f68794.js"><link rel="prefetch" href="/assets/js/189.bd9f6553.js"><link rel="prefetch" href="/assets/js/19.4ec06958.js"><link rel="prefetch" href="/assets/js/190.58f44088.js"><link rel="prefetch" href="/assets/js/191.d18a004a.js"><link rel="prefetch" href="/assets/js/192.baa806f3.js"><link rel="prefetch" href="/assets/js/193.ac0390f2.js"><link rel="prefetch" href="/assets/js/194.d08b73c9.js"><link rel="prefetch" href="/assets/js/195.a5150e23.js"><link rel="prefetch" href="/assets/js/196.29d96351.js"><link rel="prefetch" href="/assets/js/197.40da6ef9.js"><link rel="prefetch" href="/assets/js/198.b0224b47.js"><link rel="prefetch" href="/assets/js/199.b88099c5.js"><link rel="prefetch" href="/assets/js/2.05ab07af.js"><link rel="prefetch" href="/assets/js/20.96c6e214.js"><link rel="prefetch" href="/assets/js/200.094eb409.js"><link rel="prefetch" href="/assets/js/201.be93ea6d.js"><link rel="prefetch" href="/assets/js/202.797a3471.js"><link rel="prefetch" href="/assets/js/203.92dbed83.js"><link rel="prefetch" href="/assets/js/204.e400690f.js"><link rel="prefetch" href="/assets/js/205.515bd868.js"><link rel="prefetch" href="/assets/js/206.fb067f6c.js"><link rel="prefetch" href="/assets/js/207.8d47c51b.js"><link rel="prefetch" href="/assets/js/208.0f53b96a.js"><link rel="prefetch" href="/assets/js/209.2609c7a9.js"><link rel="prefetch" href="/assets/js/21.d74ad4c8.js"><link rel="prefetch" href="/assets/js/210.67450652.js"><link rel="prefetch" href="/assets/js/211.0758a923.js"><link rel="prefetch" href="/assets/js/212.60a9fd09.js"><link rel="prefetch" href="/assets/js/213.3e72050f.js"><link rel="prefetch" href="/assets/js/214.521dae03.js"><link rel="prefetch" href="/assets/js/215.2a8df540.js"><link rel="prefetch" href="/assets/js/216.25e4161b.js"><link rel="prefetch" href="/assets/js/217.6331f6ef.js"><link rel="prefetch" href="/assets/js/218.2d070d4f.js"><link rel="prefetch" href="/assets/js/219.f54ba180.js"><link rel="prefetch" href="/assets/js/220.a9928faf.js"><link rel="prefetch" href="/assets/js/221.204204e4.js"><link rel="prefetch" href="/assets/js/222.c00f3064.js"><link rel="prefetch" href="/assets/js/223.0348c071.js"><link rel="prefetch" href="/assets/js/224.15f612a3.js"><link rel="prefetch" href="/assets/js/225.8aa0f188.js"><link rel="prefetch" href="/assets/js/226.279855c0.js"><link rel="prefetch" href="/assets/js/227.c5cb7284.js"><link rel="prefetch" href="/assets/js/228.4b93668a.js"><link rel="prefetch" href="/assets/js/229.e99074ff.js"><link rel="prefetch" href="/assets/js/23.4254aa86.js"><link rel="prefetch" href="/assets/js/230.b0b5b7cf.js"><link rel="prefetch" href="/assets/js/231.c59f253e.js"><link rel="prefetch" href="/assets/js/232.c667672d.js"><link rel="prefetch" href="/assets/js/233.35f6d4ad.js"><link rel="prefetch" href="/assets/js/234.95d9d482.js"><link rel="prefetch" href="/assets/js/235.4bd3d560.js"><link rel="prefetch" href="/assets/js/236.3dc75cc5.js"><link rel="prefetch" href="/assets/js/237.860e529d.js"><link rel="prefetch" href="/assets/js/238.fbeca914.js"><link rel="prefetch" href="/assets/js/239.d0a073a8.js"><link rel="prefetch" href="/assets/js/24.a909ff00.js"><link rel="prefetch" href="/assets/js/240.4af3bcbb.js"><link rel="prefetch" href="/assets/js/241.17b36874.js"><link rel="prefetch" href="/assets/js/242.60bf82d5.js"><link rel="prefetch" href="/assets/js/243.e0b9e080.js"><link rel="prefetch" href="/assets/js/244.4aa19969.js"><link rel="prefetch" href="/assets/js/245.f7cf9ac6.js"><link rel="prefetch" href="/assets/js/246.ee83cf20.js"><link rel="prefetch" href="/assets/js/247.75a291f6.js"><link rel="prefetch" href="/assets/js/248.c84b9ddd.js"><link rel="prefetch" href="/assets/js/249.00ae1d30.js"><link rel="prefetch" href="/assets/js/25.741091b4.js"><link rel="prefetch" href="/assets/js/250.13c13703.js"><link rel="prefetch" href="/assets/js/251.71489d16.js"><link rel="prefetch" href="/assets/js/252.a24c21fd.js"><link rel="prefetch" href="/assets/js/253.cd66eb86.js"><link rel="prefetch" href="/assets/js/254.5eff9bd3.js"><link rel="prefetch" href="/assets/js/255.95d597da.js"><link rel="prefetch" href="/assets/js/256.fd2a25de.js"><link rel="prefetch" href="/assets/js/257.6014adc6.js"><link rel="prefetch" href="/assets/js/258.c6577609.js"><link rel="prefetch" href="/assets/js/259.24b8190b.js"><link rel="prefetch" href="/assets/js/26.3abc934b.js"><link rel="prefetch" href="/assets/js/260.60317117.js"><link rel="prefetch" href="/assets/js/261.c491512c.js"><link rel="prefetch" href="/assets/js/262.7c0b5345.js"><link rel="prefetch" href="/assets/js/263.9018b475.js"><link rel="prefetch" href="/assets/js/264.c3a7fed4.js"><link rel="prefetch" href="/assets/js/265.06dbc31e.js"><link rel="prefetch" href="/assets/js/266.8d84431c.js"><link rel="prefetch" href="/assets/js/267.fd6ed473.js"><link rel="prefetch" href="/assets/js/268.b71d6b19.js"><link rel="prefetch" href="/assets/js/269.ac6da1e5.js"><link rel="prefetch" href="/assets/js/27.84b86544.js"><link rel="prefetch" href="/assets/js/270.a3311d28.js"><link rel="prefetch" href="/assets/js/271.bf86334e.js"><link rel="prefetch" href="/assets/js/272.b1e7f413.js"><link rel="prefetch" href="/assets/js/273.e6c9e422.js"><link rel="prefetch" href="/assets/js/274.7b8a78b4.js"><link rel="prefetch" href="/assets/js/275.9fad6acf.js"><link rel="prefetch" href="/assets/js/276.7132798a.js"><link rel="prefetch" href="/assets/js/277.87a2269e.js"><link rel="prefetch" href="/assets/js/278.c2060d2a.js"><link rel="prefetch" href="/assets/js/279.0e644b31.js"><link rel="prefetch" href="/assets/js/28.9f4f44b5.js"><link rel="prefetch" href="/assets/js/280.f713fc0f.js"><link rel="prefetch" href="/assets/js/281.b7bcfd59.js"><link rel="prefetch" href="/assets/js/282.6f457f22.js"><link rel="prefetch" href="/assets/js/283.af75297e.js"><link rel="prefetch" href="/assets/js/284.7209427c.js"><link rel="prefetch" href="/assets/js/285.ace70aa0.js"><link rel="prefetch" href="/assets/js/286.ddbc73f0.js"><link rel="prefetch" href="/assets/js/287.6ae89410.js"><link rel="prefetch" href="/assets/js/288.00bf0c85.js"><link rel="prefetch" href="/assets/js/289.e5d3296a.js"><link rel="prefetch" href="/assets/js/29.fda83af9.js"><link rel="prefetch" href="/assets/js/290.20eaece2.js"><link rel="prefetch" href="/assets/js/291.ad6e70c4.js"><link rel="prefetch" href="/assets/js/292.7bc76ed6.js"><link rel="prefetch" href="/assets/js/293.a5d5bf80.js"><link rel="prefetch" href="/assets/js/294.9db62c85.js"><link rel="prefetch" href="/assets/js/295.b1d9fe71.js"><link rel="prefetch" href="/assets/js/296.6d778332.js"><link rel="prefetch" href="/assets/js/297.93434d36.js"><link rel="prefetch" href="/assets/js/298.793dfaab.js"><link rel="prefetch" href="/assets/js/299.14919c61.js"><link rel="prefetch" href="/assets/js/3.64382d6e.js"><link rel="prefetch" href="/assets/js/30.d16e2f8c.js"><link rel="prefetch" href="/assets/js/300.477b93a4.js"><link rel="prefetch" href="/assets/js/301.2444e8c3.js"><link rel="prefetch" href="/assets/js/302.c95ad566.js"><link rel="prefetch" href="/assets/js/303.752154c7.js"><link rel="prefetch" href="/assets/js/304.148717d2.js"><link rel="prefetch" href="/assets/js/305.a2316aaa.js"><link rel="prefetch" href="/assets/js/306.c0049e20.js"><link rel="prefetch" href="/assets/js/307.e6cdfd2a.js"><link rel="prefetch" href="/assets/js/308.abf7735c.js"><link rel="prefetch" href="/assets/js/309.ef5ee5dc.js"><link rel="prefetch" href="/assets/js/31.2de963bf.js"><link rel="prefetch" href="/assets/js/310.58f80902.js"><link rel="prefetch" href="/assets/js/311.20cbc19a.js"><link rel="prefetch" href="/assets/js/312.9a47e3f4.js"><link rel="prefetch" href="/assets/js/313.4dc59def.js"><link rel="prefetch" href="/assets/js/314.8aec6ae6.js"><link rel="prefetch" href="/assets/js/315.61e197ff.js"><link rel="prefetch" href="/assets/js/316.bebeb6d3.js"><link rel="prefetch" href="/assets/js/317.074fa4fe.js"><link rel="prefetch" href="/assets/js/318.f3e6c048.js"><link rel="prefetch" href="/assets/js/319.2b2d97ee.js"><link rel="prefetch" href="/assets/js/32.4dd953c9.js"><link rel="prefetch" href="/assets/js/320.0b45af8f.js"><link rel="prefetch" href="/assets/js/321.b859a98b.js"><link rel="prefetch" href="/assets/js/322.9e0b3c16.js"><link rel="prefetch" href="/assets/js/323.3de1db97.js"><link rel="prefetch" href="/assets/js/324.7d7c09cd.js"><link rel="prefetch" href="/assets/js/325.f2dd52c8.js"><link rel="prefetch" href="/assets/js/326.808fa50e.js"><link rel="prefetch" href="/assets/js/327.84cd3c8d.js"><link rel="prefetch" href="/assets/js/328.1eb02d6c.js"><link rel="prefetch" href="/assets/js/329.c56f7d5e.js"><link rel="prefetch" href="/assets/js/33.c10014ab.js"><link rel="prefetch" href="/assets/js/330.fe65d9ba.js"><link rel="prefetch" href="/assets/js/331.fa2102ec.js"><link rel="prefetch" href="/assets/js/332.4134ae7c.js"><link rel="prefetch" href="/assets/js/333.74d1e28c.js"><link rel="prefetch" href="/assets/js/334.1cbe8189.js"><link rel="prefetch" href="/assets/js/335.ff6a8784.js"><link rel="prefetch" href="/assets/js/336.42a7f3ea.js"><link rel="prefetch" href="/assets/js/337.a42a490d.js"><link rel="prefetch" href="/assets/js/338.55b54abd.js"><link rel="prefetch" href="/assets/js/339.7e83fa2e.js"><link rel="prefetch" href="/assets/js/34.e2db553c.js"><link rel="prefetch" href="/assets/js/340.cde4bb19.js"><link rel="prefetch" href="/assets/js/341.c4d5b671.js"><link rel="prefetch" href="/assets/js/342.1e3e7825.js"><link rel="prefetch" href="/assets/js/343.8997cf7a.js"><link rel="prefetch" href="/assets/js/344.98774b7e.js"><link rel="prefetch" href="/assets/js/345.b3c4eda3.js"><link rel="prefetch" href="/assets/js/346.851b80e1.js"><link rel="prefetch" href="/assets/js/347.52b34cf9.js"><link rel="prefetch" href="/assets/js/348.9d35471b.js"><link rel="prefetch" href="/assets/js/349.dd61f6bc.js"><link rel="prefetch" href="/assets/js/35.fa92dc25.js"><link rel="prefetch" href="/assets/js/350.a545e3e3.js"><link rel="prefetch" href="/assets/js/351.90a1563a.js"><link rel="prefetch" href="/assets/js/352.63b69bdf.js"><link rel="prefetch" href="/assets/js/353.e36b4563.js"><link rel="prefetch" href="/assets/js/354.4e341f30.js"><link rel="prefetch" href="/assets/js/355.49299eac.js"><link rel="prefetch" href="/assets/js/356.87f388ef.js"><link rel="prefetch" href="/assets/js/357.aa346e2f.js"><link rel="prefetch" href="/assets/js/358.166548d5.js"><link rel="prefetch" href="/assets/js/359.913b5170.js"><link rel="prefetch" href="/assets/js/36.3e743c23.js"><link rel="prefetch" href="/assets/js/360.148c4e27.js"><link rel="prefetch" href="/assets/js/361.05f4b616.js"><link rel="prefetch" href="/assets/js/362.9bfc29e9.js"><link rel="prefetch" href="/assets/js/363.0d0ff918.js"><link rel="prefetch" href="/assets/js/364.5f3bd1b8.js"><link rel="prefetch" href="/assets/js/365.ae37ebee.js"><link rel="prefetch" href="/assets/js/366.54649f83.js"><link rel="prefetch" href="/assets/js/367.45368fba.js"><link rel="prefetch" href="/assets/js/368.5d62f4da.js"><link rel="prefetch" href="/assets/js/369.0d44c4e5.js"><link rel="prefetch" href="/assets/js/37.fdbef4a2.js"><link rel="prefetch" href="/assets/js/370.0e5e2ce7.js"><link rel="prefetch" href="/assets/js/371.01fdb6d5.js"><link rel="prefetch" href="/assets/js/372.bc4d4c09.js"><link rel="prefetch" href="/assets/js/373.726da6b8.js"><link rel="prefetch" href="/assets/js/374.a829bae8.js"><link rel="prefetch" href="/assets/js/375.f0835cd6.js"><link rel="prefetch" href="/assets/js/376.adc09470.js"><link rel="prefetch" href="/assets/js/377.0118125a.js"><link rel="prefetch" href="/assets/js/378.03e4b784.js"><link rel="prefetch" href="/assets/js/379.3710fc48.js"><link rel="prefetch" href="/assets/js/38.c79ad624.js"><link rel="prefetch" href="/assets/js/380.46b17595.js"><link rel="prefetch" href="/assets/js/381.c4b66b3f.js"><link rel="prefetch" href="/assets/js/382.6ce0193a.js"><link rel="prefetch" href="/assets/js/383.1422040a.js"><link rel="prefetch" href="/assets/js/384.7aed11a4.js"><link rel="prefetch" href="/assets/js/385.442ac931.js"><link rel="prefetch" href="/assets/js/386.93fcfd17.js"><link rel="prefetch" href="/assets/js/387.8f44920a.js"><link rel="prefetch" href="/assets/js/388.799b85be.js"><link rel="prefetch" href="/assets/js/389.0dfb4ad6.js"><link rel="prefetch" href="/assets/js/39.35ebb4f4.js"><link rel="prefetch" href="/assets/js/390.1b1bdfdf.js"><link rel="prefetch" href="/assets/js/391.605497bb.js"><link rel="prefetch" href="/assets/js/392.da1d3a21.js"><link rel="prefetch" href="/assets/js/393.412be930.js"><link rel="prefetch" href="/assets/js/394.2c44ee3b.js"><link rel="prefetch" href="/assets/js/395.bb61b7c1.js"><link rel="prefetch" href="/assets/js/396.31b9c155.js"><link rel="prefetch" href="/assets/js/397.f8f966da.js"><link rel="prefetch" href="/assets/js/398.008e010d.js"><link rel="prefetch" href="/assets/js/399.72f7bd35.js"><link rel="prefetch" href="/assets/js/4.6d51c94b.js"><link rel="prefetch" href="/assets/js/40.d1ced2c0.js"><link rel="prefetch" href="/assets/js/400.94f008e2.js"><link rel="prefetch" href="/assets/js/401.f6b43f96.js"><link rel="prefetch" href="/assets/js/402.cffa1355.js"><link rel="prefetch" href="/assets/js/403.901c51e2.js"><link rel="prefetch" href="/assets/js/404.4af8d1c5.js"><link rel="prefetch" href="/assets/js/405.449866fa.js"><link rel="prefetch" href="/assets/js/406.189530aa.js"><link rel="prefetch" href="/assets/js/407.e1960a4f.js"><link rel="prefetch" href="/assets/js/408.e9c0674d.js"><link rel="prefetch" href="/assets/js/409.b88049ad.js"><link rel="prefetch" href="/assets/js/41.af602fe1.js"><link rel="prefetch" href="/assets/js/410.3a0fbdc1.js"><link rel="prefetch" href="/assets/js/411.1a250198.js"><link rel="prefetch" href="/assets/js/412.6001ff3e.js"><link rel="prefetch" href="/assets/js/413.d9caef8e.js"><link rel="prefetch" href="/assets/js/414.2db55e1b.js"><link rel="prefetch" href="/assets/js/415.e9576432.js"><link rel="prefetch" href="/assets/js/416.43aa4450.js"><link rel="prefetch" href="/assets/js/417.33f1c825.js"><link rel="prefetch" href="/assets/js/418.f78ca97d.js"><link rel="prefetch" href="/assets/js/419.4893471f.js"><link rel="prefetch" href="/assets/js/42.b624ad9d.js"><link rel="prefetch" href="/assets/js/420.6d0135cc.js"><link rel="prefetch" href="/assets/js/421.7836a8cc.js"><link rel="prefetch" href="/assets/js/422.fcd977dc.js"><link rel="prefetch" href="/assets/js/423.4af10626.js"><link rel="prefetch" href="/assets/js/424.879aed9b.js"><link rel="prefetch" href="/assets/js/425.e002317f.js"><link rel="prefetch" href="/assets/js/426.4cebc11c.js"><link rel="prefetch" href="/assets/js/427.3b021793.js"><link rel="prefetch" href="/assets/js/428.66a499e3.js"><link rel="prefetch" href="/assets/js/429.dec8a429.js"><link rel="prefetch" href="/assets/js/43.272e284b.js"><link rel="prefetch" href="/assets/js/430.de29b476.js"><link rel="prefetch" href="/assets/js/431.3818e7e2.js"><link rel="prefetch" href="/assets/js/432.228f7128.js"><link rel="prefetch" href="/assets/js/433.1b7aa64e.js"><link rel="prefetch" href="/assets/js/434.ddc98a22.js"><link rel="prefetch" href="/assets/js/435.54742473.js"><link rel="prefetch" href="/assets/js/436.dd343703.js"><link rel="prefetch" href="/assets/js/437.89317faf.js"><link rel="prefetch" href="/assets/js/438.9cadcd53.js"><link rel="prefetch" href="/assets/js/439.4de4d013.js"><link rel="prefetch" href="/assets/js/44.38379526.js"><link rel="prefetch" href="/assets/js/440.e51db2b6.js"><link rel="prefetch" href="/assets/js/441.4f1ff726.js"><link rel="prefetch" href="/assets/js/442.9382eb15.js"><link rel="prefetch" href="/assets/js/443.0f1de840.js"><link rel="prefetch" href="/assets/js/444.300d598b.js"><link rel="prefetch" href="/assets/js/445.17187d08.js"><link rel="prefetch" href="/assets/js/446.83fad92f.js"><link rel="prefetch" href="/assets/js/447.5f0e5e7b.js"><link rel="prefetch" href="/assets/js/448.7dc5594e.js"><link rel="prefetch" href="/assets/js/449.e945c24a.js"><link rel="prefetch" href="/assets/js/45.c62d61a5.js"><link rel="prefetch" href="/assets/js/450.6ad2b9b1.js"><link rel="prefetch" href="/assets/js/451.6041f187.js"><link rel="prefetch" href="/assets/js/452.5395e176.js"><link rel="prefetch" href="/assets/js/453.176b077e.js"><link rel="prefetch" href="/assets/js/454.81b77b6a.js"><link rel="prefetch" href="/assets/js/455.1ff7a55e.js"><link rel="prefetch" href="/assets/js/456.5b6ffaca.js"><link rel="prefetch" href="/assets/js/457.b3ca053e.js"><link rel="prefetch" href="/assets/js/458.efc82aea.js"><link rel="prefetch" href="/assets/js/459.0fd2fbd3.js"><link rel="prefetch" href="/assets/js/46.a9311b58.js"><link rel="prefetch" href="/assets/js/460.590c15f2.js"><link rel="prefetch" href="/assets/js/461.50aca98a.js"><link rel="prefetch" href="/assets/js/462.f8e117e8.js"><link rel="prefetch" href="/assets/js/463.e2ae1e44.js"><link rel="prefetch" href="/assets/js/464.89b197be.js"><link rel="prefetch" href="/assets/js/465.cb0ff9ca.js"><link rel="prefetch" href="/assets/js/466.9dd6e996.js"><link rel="prefetch" href="/assets/js/467.78541213.js"><link rel="prefetch" href="/assets/js/468.670dfe4b.js"><link rel="prefetch" href="/assets/js/469.616d3cf7.js"><link rel="prefetch" href="/assets/js/47.e1c5ba92.js"><link rel="prefetch" href="/assets/js/470.f9ea40c5.js"><link rel="prefetch" href="/assets/js/471.8125c141.js"><link rel="prefetch" href="/assets/js/472.cf202222.js"><link rel="prefetch" href="/assets/js/473.dfef54bd.js"><link rel="prefetch" href="/assets/js/474.8eefdbd6.js"><link rel="prefetch" href="/assets/js/475.12152f36.js"><link rel="prefetch" href="/assets/js/476.6768d931.js"><link rel="prefetch" href="/assets/js/477.c61b65bc.js"><link rel="prefetch" href="/assets/js/478.790ab6b8.js"><link rel="prefetch" href="/assets/js/479.a575caaa.js"><link rel="prefetch" href="/assets/js/48.ae0c524d.js"><link rel="prefetch" href="/assets/js/480.885ee98d.js"><link rel="prefetch" href="/assets/js/481.a6144642.js"><link rel="prefetch" href="/assets/js/482.b63db91d.js"><link rel="prefetch" href="/assets/js/483.05f534a4.js"><link rel="prefetch" href="/assets/js/484.6ff11aec.js"><link rel="prefetch" href="/assets/js/485.1fb196a5.js"><link rel="prefetch" href="/assets/js/486.a5ba7f2c.js"><link rel="prefetch" href="/assets/js/487.14edee22.js"><link rel="prefetch" href="/assets/js/488.f637be7a.js"><link rel="prefetch" href="/assets/js/489.108dd63b.js"><link rel="prefetch" href="/assets/js/49.77a0b1bf.js"><link rel="prefetch" href="/assets/js/490.4f9b9b34.js"><link rel="prefetch" href="/assets/js/491.05dc1a7b.js"><link rel="prefetch" href="/assets/js/492.4560e4e4.js"><link rel="prefetch" href="/assets/js/493.40430f85.js"><link rel="prefetch" href="/assets/js/494.a31c53e1.js"><link rel="prefetch" href="/assets/js/495.24827c3d.js"><link rel="prefetch" href="/assets/js/496.a84b985a.js"><link rel="prefetch" href="/assets/js/497.36fcc993.js"><link rel="prefetch" href="/assets/js/498.30c03e60.js"><link rel="prefetch" href="/assets/js/499.f3be2550.js"><link rel="prefetch" href="/assets/js/5.7e82945a.js"><link rel="prefetch" href="/assets/js/50.00ffa03a.js"><link rel="prefetch" href="/assets/js/500.321ec5bb.js"><link rel="prefetch" href="/assets/js/501.94dc938e.js"><link rel="prefetch" href="/assets/js/502.a81a7d40.js"><link rel="prefetch" href="/assets/js/503.52fcc338.js"><link rel="prefetch" href="/assets/js/504.a621afae.js"><link rel="prefetch" href="/assets/js/505.396fe539.js"><link rel="prefetch" href="/assets/js/506.390cb216.js"><link rel="prefetch" href="/assets/js/507.cca6da35.js"><link rel="prefetch" href="/assets/js/508.10c3a8e0.js"><link rel="prefetch" href="/assets/js/509.b58db81f.js"><link rel="prefetch" href="/assets/js/51.b3077b70.js"><link rel="prefetch" href="/assets/js/510.3123b59b.js"><link rel="prefetch" href="/assets/js/511.77db2fb5.js"><link rel="prefetch" href="/assets/js/512.ef7ff2f0.js"><link rel="prefetch" href="/assets/js/513.3577d403.js"><link rel="prefetch" href="/assets/js/514.944cfc45.js"><link rel="prefetch" href="/assets/js/515.5c78620e.js"><link rel="prefetch" href="/assets/js/516.34a985ec.js"><link rel="prefetch" href="/assets/js/517.d845aebd.js"><link rel="prefetch" href="/assets/js/518.d03b1c22.js"><link rel="prefetch" href="/assets/js/519.0096fe75.js"><link rel="prefetch" href="/assets/js/52.9c1d4af3.js"><link rel="prefetch" href="/assets/js/520.20372943.js"><link rel="prefetch" href="/assets/js/521.eaa44150.js"><link rel="prefetch" href="/assets/js/522.16125162.js"><link rel="prefetch" href="/assets/js/523.c21aa9aa.js"><link rel="prefetch" href="/assets/js/524.f199d9f7.js"><link rel="prefetch" href="/assets/js/525.dbe5f427.js"><link rel="prefetch" href="/assets/js/526.2080a530.js"><link rel="prefetch" href="/assets/js/527.48e5504d.js"><link rel="prefetch" href="/assets/js/528.2f09153e.js"><link rel="prefetch" href="/assets/js/529.b219886c.js"><link rel="prefetch" href="/assets/js/53.f8312c33.js"><link rel="prefetch" href="/assets/js/530.c4225227.js"><link rel="prefetch" href="/assets/js/531.105f7d60.js"><link rel="prefetch" href="/assets/js/532.ccad7465.js"><link rel="prefetch" href="/assets/js/533.57ff8782.js"><link rel="prefetch" href="/assets/js/534.a42405fe.js"><link rel="prefetch" href="/assets/js/535.44ab8831.js"><link rel="prefetch" href="/assets/js/536.2ca28e72.js"><link rel="prefetch" href="/assets/js/537.2f3fe94f.js"><link rel="prefetch" href="/assets/js/538.a7e35532.js"><link rel="prefetch" href="/assets/js/539.d54aa45b.js"><link rel="prefetch" href="/assets/js/54.ac788cae.js"><link rel="prefetch" href="/assets/js/540.b9793969.js"><link rel="prefetch" href="/assets/js/541.692b2b23.js"><link rel="prefetch" href="/assets/js/542.c34e13a2.js"><link rel="prefetch" href="/assets/js/543.6a284ee8.js"><link rel="prefetch" href="/assets/js/544.9f592b46.js"><link rel="prefetch" href="/assets/js/545.346d435f.js"><link rel="prefetch" href="/assets/js/546.1f89f2d8.js"><link rel="prefetch" href="/assets/js/547.bd3868df.js"><link rel="prefetch" href="/assets/js/548.8c408cd5.js"><link rel="prefetch" href="/assets/js/549.e94f9a56.js"><link rel="prefetch" href="/assets/js/55.cc3e082f.js"><link rel="prefetch" href="/assets/js/550.f65bb798.js"><link rel="prefetch" href="/assets/js/551.7c456451.js"><link rel="prefetch" href="/assets/js/552.50934076.js"><link rel="prefetch" href="/assets/js/553.b17c2f9a.js"><link rel="prefetch" href="/assets/js/554.2c642a7f.js"><link rel="prefetch" href="/assets/js/555.7ebdf464.js"><link rel="prefetch" href="/assets/js/556.b982d368.js"><link rel="prefetch" href="/assets/js/557.376d9a95.js"><link rel="prefetch" href="/assets/js/558.ff41d3d0.js"><link rel="prefetch" href="/assets/js/559.b5ab2b72.js"><link rel="prefetch" href="/assets/js/56.251db949.js"><link rel="prefetch" href="/assets/js/560.c68ad00b.js"><link rel="prefetch" href="/assets/js/561.93bbaaf9.js"><link rel="prefetch" href="/assets/js/562.12f7c281.js"><link rel="prefetch" href="/assets/js/563.96c9851a.js"><link rel="prefetch" href="/assets/js/564.6354d5e2.js"><link rel="prefetch" href="/assets/js/565.d6652933.js"><link rel="prefetch" href="/assets/js/566.cdd849b2.js"><link rel="prefetch" href="/assets/js/567.2e96c3a5.js"><link rel="prefetch" href="/assets/js/568.15b278f9.js"><link rel="prefetch" href="/assets/js/569.7ae68487.js"><link rel="prefetch" href="/assets/js/57.47e9e96f.js"><link rel="prefetch" href="/assets/js/570.2f0add43.js"><link rel="prefetch" href="/assets/js/571.678d88f7.js"><link rel="prefetch" href="/assets/js/572.9847aee1.js"><link rel="prefetch" href="/assets/js/573.bae689ff.js"><link rel="prefetch" href="/assets/js/574.7359f2b7.js"><link rel="prefetch" href="/assets/js/575.9a41cc0a.js"><link rel="prefetch" href="/assets/js/576.0eed48fa.js"><link rel="prefetch" href="/assets/js/577.9ab9ed4a.js"><link rel="prefetch" href="/assets/js/578.a6e8435f.js"><link rel="prefetch" href="/assets/js/579.e9732a29.js"><link rel="prefetch" href="/assets/js/58.4fe190d9.js"><link rel="prefetch" href="/assets/js/580.9ae62ab8.js"><link rel="prefetch" href="/assets/js/581.9c114f91.js"><link rel="prefetch" href="/assets/js/582.46cde29e.js"><link rel="prefetch" href="/assets/js/583.769f46a5.js"><link rel="prefetch" href="/assets/js/584.e5acd154.js"><link rel="prefetch" href="/assets/js/585.4aa8b363.js"><link rel="prefetch" href="/assets/js/586.6f6c5e55.js"><link rel="prefetch" href="/assets/js/587.f969689d.js"><link rel="prefetch" href="/assets/js/588.d01d0f26.js"><link rel="prefetch" href="/assets/js/589.3622e422.js"><link rel="prefetch" href="/assets/js/59.d108149e.js"><link rel="prefetch" href="/assets/js/590.5a32ec73.js"><link rel="prefetch" href="/assets/js/591.475597d4.js"><link rel="prefetch" href="/assets/js/592.a342c52e.js"><link rel="prefetch" href="/assets/js/593.05bfd63a.js"><link rel="prefetch" href="/assets/js/594.0c94a0f2.js"><link rel="prefetch" href="/assets/js/595.890ef672.js"><link rel="prefetch" href="/assets/js/596.e34c490f.js"><link rel="prefetch" href="/assets/js/597.c929462f.js"><link rel="prefetch" href="/assets/js/598.a71ad11a.js"><link rel="prefetch" href="/assets/js/599.b6e1a9e0.js"><link rel="prefetch" href="/assets/js/6.155f3fc4.js"><link rel="prefetch" href="/assets/js/60.c832149d.js"><link rel="prefetch" href="/assets/js/600.30fdb65d.js"><link rel="prefetch" href="/assets/js/601.8bba2838.js"><link rel="prefetch" href="/assets/js/602.7e41c67f.js"><link rel="prefetch" href="/assets/js/603.1eae68fb.js"><link rel="prefetch" href="/assets/js/604.ce969e20.js"><link rel="prefetch" href="/assets/js/605.513118c9.js"><link rel="prefetch" href="/assets/js/606.038dda89.js"><link rel="prefetch" href="/assets/js/607.cd11f5be.js"><link rel="prefetch" href="/assets/js/608.c33caa91.js"><link rel="prefetch" href="/assets/js/609.f908e400.js"><link rel="prefetch" href="/assets/js/61.f7d78a3f.js"><link rel="prefetch" href="/assets/js/610.4cd85518.js"><link rel="prefetch" href="/assets/js/611.c16196b9.js"><link rel="prefetch" href="/assets/js/612.15162682.js"><link rel="prefetch" href="/assets/js/613.5529956f.js"><link rel="prefetch" href="/assets/js/614.02e8a7c0.js"><link rel="prefetch" href="/assets/js/615.c240edd2.js"><link rel="prefetch" href="/assets/js/616.45b3c1b0.js"><link rel="prefetch" href="/assets/js/617.59b80c45.js"><link rel="prefetch" href="/assets/js/618.02740266.js"><link rel="prefetch" href="/assets/js/619.271ddb7e.js"><link rel="prefetch" href="/assets/js/62.5e323ed8.js"><link rel="prefetch" href="/assets/js/620.ab62d550.js"><link rel="prefetch" href="/assets/js/621.b9076e31.js"><link rel="prefetch" href="/assets/js/622.e9949cac.js"><link rel="prefetch" href="/assets/js/623.82585724.js"><link rel="prefetch" href="/assets/js/624.2afd2047.js"><link rel="prefetch" href="/assets/js/625.dd00910f.js"><link rel="prefetch" href="/assets/js/626.7714d775.js"><link rel="prefetch" href="/assets/js/627.7b960ee4.js"><link rel="prefetch" href="/assets/js/628.5d54bad0.js"><link rel="prefetch" href="/assets/js/629.5ce58c8d.js"><link rel="prefetch" href="/assets/js/63.6b1f9a8d.js"><link rel="prefetch" href="/assets/js/630.4f8f6d3b.js"><link rel="prefetch" href="/assets/js/631.1f35d7a8.js"><link rel="prefetch" href="/assets/js/632.eda19165.js"><link rel="prefetch" href="/assets/js/633.38a91dcf.js"><link rel="prefetch" href="/assets/js/634.0db5aad4.js"><link rel="prefetch" href="/assets/js/635.a09a8dc4.js"><link rel="prefetch" href="/assets/js/636.7ff8081e.js"><link rel="prefetch" href="/assets/js/637.4626b3f8.js"><link rel="prefetch" href="/assets/js/638.f33db688.js"><link rel="prefetch" href="/assets/js/639.6caa588e.js"><link rel="prefetch" href="/assets/js/64.6460563a.js"><link rel="prefetch" href="/assets/js/640.68b47832.js"><link rel="prefetch" href="/assets/js/641.0f11b9e9.js"><link rel="prefetch" href="/assets/js/642.899d78bb.js"><link rel="prefetch" href="/assets/js/643.4d54bbe5.js"><link rel="prefetch" href="/assets/js/644.a35d0a54.js"><link rel="prefetch" href="/assets/js/645.e8348e00.js"><link rel="prefetch" href="/assets/js/646.78b9fe5d.js"><link rel="prefetch" href="/assets/js/647.8662a3eb.js"><link rel="prefetch" href="/assets/js/648.ae7d9f12.js"><link rel="prefetch" href="/assets/js/649.c5c8c935.js"><link rel="prefetch" href="/assets/js/65.809095c1.js"><link rel="prefetch" href="/assets/js/650.2f018fd4.js"><link rel="prefetch" href="/assets/js/651.c47de8a9.js"><link rel="prefetch" href="/assets/js/652.2f72bab2.js"><link rel="prefetch" href="/assets/js/653.9b10a971.js"><link rel="prefetch" href="/assets/js/654.7d8bc0b4.js"><link rel="prefetch" href="/assets/js/655.b0a6a94b.js"><link rel="prefetch" href="/assets/js/656.7ccc236f.js"><link rel="prefetch" href="/assets/js/657.99ea557d.js"><link rel="prefetch" href="/assets/js/658.a6a1150a.js"><link rel="prefetch" href="/assets/js/659.29ed30ad.js"><link rel="prefetch" href="/assets/js/66.5b8f374d.js"><link rel="prefetch" href="/assets/js/660.b95a6ed7.js"><link rel="prefetch" href="/assets/js/661.6e19ca44.js"><link rel="prefetch" href="/assets/js/662.099f8ada.js"><link rel="prefetch" href="/assets/js/663.8c38f532.js"><link rel="prefetch" href="/assets/js/664.d6711a62.js"><link rel="prefetch" href="/assets/js/665.1a7b0e62.js"><link rel="prefetch" href="/assets/js/666.60f2e697.js"><link rel="prefetch" href="/assets/js/67.e18a4597.js"><link rel="prefetch" href="/assets/js/68.b968d878.js"><link rel="prefetch" href="/assets/js/69.57482e93.js"><link rel="prefetch" href="/assets/js/7.81963284.js"><link rel="prefetch" href="/assets/js/70.5cdc3899.js"><link rel="prefetch" href="/assets/js/71.606c21aa.js"><link rel="prefetch" href="/assets/js/72.0e930a37.js"><link rel="prefetch" href="/assets/js/73.fc70abe4.js"><link rel="prefetch" href="/assets/js/74.f6616c29.js"><link rel="prefetch" href="/assets/js/75.d526bc33.js"><link rel="prefetch" href="/assets/js/76.8838c853.js"><link rel="prefetch" href="/assets/js/77.24e0da66.js"><link rel="prefetch" href="/assets/js/78.b9eae5e0.js"><link rel="prefetch" href="/assets/js/79.681e0e94.js"><link rel="prefetch" href="/assets/js/8.5c2761b0.js"><link rel="prefetch" href="/assets/js/80.785a6860.js"><link rel="prefetch" href="/assets/js/81.7e182092.js"><link rel="prefetch" href="/assets/js/82.c7b45120.js"><link rel="prefetch" href="/assets/js/83.f415ad73.js"><link rel="prefetch" href="/assets/js/84.cabdd71b.js"><link rel="prefetch" href="/assets/js/85.174d53d4.js"><link rel="prefetch" href="/assets/js/86.d67e626d.js"><link rel="prefetch" href="/assets/js/87.fc9a94c7.js"><link rel="prefetch" href="/assets/js/88.000c4ac2.js"><link rel="prefetch" href="/assets/js/89.c0d92e52.js"><link rel="prefetch" href="/assets/js/9.538a961a.js"><link rel="prefetch" href="/assets/js/90.46fb8aae.js"><link rel="prefetch" href="/assets/js/91.65795799.js"><link rel="prefetch" href="/assets/js/92.cb25c562.js"><link rel="prefetch" href="/assets/js/93.b9e47609.js"><link rel="prefetch" href="/assets/js/94.fb2e4f9a.js"><link rel="prefetch" href="/assets/js/95.a0ba60fa.js"><link rel="prefetch" href="/assets/js/96.4f2ea100.js"><link rel="prefetch" href="/assets/js/97.d7048da3.js"><link rel="prefetch" href="/assets/js/98.627aa4db.js"><link rel="prefetch" href="/assets/js/99.248f080e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0806f82e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Home</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/" class="nav-link">
  JAVA
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  MySql
</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">
  云原生
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计模式" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="设计模式" class="mobile-dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/imocc/design_pattern/" class="nav-link">
  设计模式（慕课）
</a></li><li class="dropdown-item"><!----> <a href="/design_pattern/" class="nav-link">
  研磨设计模式（李兴华）
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Elasticsearch" class="dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow down"></span></button> <button type="button" aria-label="Elasticsearch" class="mobile-dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/elasticsearch-core/" class="nav-link">
  核心知识篇
</a></li><li class="dropdown-item"><!----> <a href="/elasticsearch-senior/" class="nav-link">
  高级知识篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="dropdown-title"><span class="title">分布式缓存</span> <span class="arrow down"></span></button> <button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="mobile-dropdown-title"><span class="title">分布式缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          综合性导航
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cache-pdp/" class="nav-link">
  全目录导航
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/001-introduce.html" class="nav-link">
  第一版（001 ~ 123 章）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/124.html" class="nav-link">
  第二版（124 ~ 195 章）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/121.html" class="nav-link">
  课程总结（难题与解决方案）
</a></li></ul></li><li class="dropdown-item"><h4>
          精彩知识精选
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cache-pdp/redis/007.html" class="nav-link">
  Redis 篇（redis 企业级集群架构）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/035.html" class="nav-link">
  多级缓存架构设计
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/040.html" class="nav-link">
  数据库 + 缓存双写一致性解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/045.html" class="nav-link">
  缓存维度化拆分解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/051.html" class="nav-link">
  缓存命中率提升解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/057.html" class="nav-link">
  缓存并发重建冲突解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/069.html" class="nav-link">
  缓存预热解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/077.html" class="nav-link">
  热点缓存自动降级方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/110.html" class="nav-link">
  缓存雪崩解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/117.html" class="nav-link">
  缓存穿透解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/119.html" class="nav-link">
  缓存失效解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/hystrix/084.html" class="nav-link">
  高可用分布式系统架构设计（hystrix 篇）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/047.html" class="nav-link">
  spring boot 整合 ehcache
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/storm/062.html" class="nav-link">
  史上最通俗易懂 Storm 教程
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/introduce/" class="nav-link">
  本笔记介绍
</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud-tutorial/" class="nav-link">
  Spring Cloud
</a></li><li class="dropdown-item"><!----> <a href="/css-zxx/" class="nav-link">
  CSS 深入理解（张鑫旭）
</a></li><li class="dropdown-item"><!----> <a href="/regular/" class="nav-link">
  正则入门
</a></li><li class="dropdown-item"><h4>
          思路拓展
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/back-end-storage/" class="nav-link">
  后端存储实战
</a></li><li class="dropdown-subitem"><a href="/middle-office/" class="nav-link">
  说透中台
</a></li><li class="dropdown-subitem"><a href="/oath2/" class="nav-link router-link-active">
  Oath 2.0 实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Git
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/" class="nav-link">
  Git 零散知识
</a></li><li class="dropdown-subitem"><a href="/git-scm/" class="nav-link">
  Git 系统学习笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          Mycat
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mycat/" class="nav-link">
  Mycat 1
</a></li><li class="dropdown-subitem"><a href="/mycat2/" class="nav-link">
  Mycat 2
</a></li></ul></li><li class="dropdown-item"><h4>
          笔记精选汇总
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://google.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub 站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><!----> <a href="/posts-failure.html" class="nav-link">
  博客文章 /_posts/ 路径失效说明
</a></li></ul></div></div> <a href="https://github.com/luckmaosh/luckmaosh.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/" class="nav-link">
  JAVA
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  MySql
</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">
  云原生
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计模式" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="设计模式" class="mobile-dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/imocc/design_pattern/" class="nav-link">
  设计模式（慕课）
</a></li><li class="dropdown-item"><!----> <a href="/design_pattern/" class="nav-link">
  研磨设计模式（李兴华）
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Elasticsearch" class="dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow down"></span></button> <button type="button" aria-label="Elasticsearch" class="mobile-dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/elasticsearch-core/" class="nav-link">
  核心知识篇
</a></li><li class="dropdown-item"><!----> <a href="/elasticsearch-senior/" class="nav-link">
  高级知识篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="dropdown-title"><span class="title">分布式缓存</span> <span class="arrow down"></span></button> <button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="mobile-dropdown-title"><span class="title">分布式缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          综合性导航
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cache-pdp/" class="nav-link">
  全目录导航
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/001-introduce.html" class="nav-link">
  第一版（001 ~ 123 章）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/124.html" class="nav-link">
  第二版（124 ~ 195 章）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/121.html" class="nav-link">
  课程总结（难题与解决方案）
</a></li></ul></li><li class="dropdown-item"><h4>
          精彩知识精选
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cache-pdp/redis/007.html" class="nav-link">
  Redis 篇（redis 企业级集群架构）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/035.html" class="nav-link">
  多级缓存架构设计
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/040.html" class="nav-link">
  数据库 + 缓存双写一致性解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/045.html" class="nav-link">
  缓存维度化拆分解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/051.html" class="nav-link">
  缓存命中率提升解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/057.html" class="nav-link">
  缓存并发重建冲突解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/069.html" class="nav-link">
  缓存预热解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/077.html" class="nav-link">
  热点缓存自动降级方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/110.html" class="nav-link">
  缓存雪崩解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/117.html" class="nav-link">
  缓存穿透解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/119.html" class="nav-link">
  缓存失效解决方案
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/hystrix/084.html" class="nav-link">
  高可用分布式系统架构设计（hystrix 篇）
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/047.html" class="nav-link">
  spring boot 整合 ehcache
</a></li><li class="dropdown-subitem"><a href="/cache-pdp/storm/062.html" class="nav-link">
  史上最通俗易懂 Storm 教程
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/introduce/" class="nav-link">
  本笔记介绍
</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud-tutorial/" class="nav-link">
  Spring Cloud
</a></li><li class="dropdown-item"><!----> <a href="/css-zxx/" class="nav-link">
  CSS 深入理解（张鑫旭）
</a></li><li class="dropdown-item"><!----> <a href="/regular/" class="nav-link">
  正则入门
</a></li><li class="dropdown-item"><h4>
          思路拓展
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/back-end-storage/" class="nav-link">
  后端存储实战
</a></li><li class="dropdown-subitem"><a href="/middle-office/" class="nav-link">
  说透中台
</a></li><li class="dropdown-subitem"><a href="/oath2/" class="nav-link router-link-active">
  Oath 2.0 实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Git
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/" class="nav-link">
  Git 零散知识
</a></li><li class="dropdown-subitem"><a href="/git-scm/" class="nav-link">
  Git 系统学习笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          Mycat
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mycat/" class="nav-link">
  Mycat 1
</a></li><li class="dropdown-subitem"><a href="/mycat2/" class="nav-link">
  Mycat 2
</a></li></ul></li><li class="dropdown-item"><h4>
          笔记精选汇总
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://google.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub 站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><!----> <a href="/posts-failure.html" class="nav-link">
  博客文章 /_posts/ 路径失效说明
</a></li></ul></div></div> <a href="https://github.com/luckmaosh/luckmaosh.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/oath2/" aria-current="page" class="sidebar-link">OAuth 2.0 实战</a></li><li><a href="/oath2/00/" class="sidebar-link">为什么要学 OAuth 2.0？</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>进阶篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/oath2/02/" aria-current="page" class="sidebar-link">进阶篇</a></li><li><a href="/oath2/02/01.html" class="sidebar-link">如何在移动 App 中使用 OAuth 2.0？</a></li><li><a href="/oath2/02/02.html" class="sidebar-link">实践 OAuth 2.0 时，使用不当可能会导致哪些安全漏洞？</a></li><li><a href="/oath2/02/03.html" class="sidebar-link">实战：利用 OAuth 2.0 实现一个 OpenID Connect 用户身份认证协议</a></li><li><a href="/oath2/02/04.html" class="sidebar-link">串讲：OAuth 2.0 的工作流程与安全问题</a></li><li><a href="/oath2/02/05.html" aria-current="page" class="active sidebar-link">实战案例：使用 Spring Security 搭建一套基于 JWT 的 OAuth 2.0 架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oath2/02/05.html#项目准备工作" class="sidebar-link">项目准备工作</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#搭建授权服务器" class="sidebar-link">搭建授权服务器</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#搭建受保护资源服务器" class="sidebar-link">搭建受保护资源服务器</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#初始化数据配置" class="sidebar-link">初始化数据配置</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#演示三种授权许可类型" class="sidebar-link">演示三种授权许可类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oath2/02/05.html#资源拥有者凭据许可类型" class="sidebar-link">资源拥有者凭据许可类型</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#客户端授权许可类型" class="sidebar-link">客户端授权许可类型</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#授权码许可类型" class="sidebar-link">授权码许可类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#演示权限控制" class="sidebar-link">演示权限控制</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#搭建客户端程序" class="sidebar-link">搭建客户端程序</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#演示单点登录" class="sidebar-link">演示单点登录</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#演示客户端请求资源服务器资源" class="sidebar-link">演示客户端请求资源服务器资源</a></li><li class="sidebar-sub-header"><a href="/oath2/02/05.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/oath2/02/06.html" class="sidebar-link">架构案例：基于 OAuth 2.0/JWT 的微服务参考架构</a></li><li><a href="/oath2/02/07.html" class="sidebar-link">各大开放平台是如何使用 OAuth 2.0 的？</a></li><li><a href="/oath2/02/08.html" class="sidebar-link">查漏补缺：OAuth 2.0 常见问题答疑</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实战案例-使用-spring-security-搭建一套基于-jwt-的-oauth-2-0-架构"><a href="#实战案例-使用-spring-security-搭建一套基于-jwt-的-oauth-2-0-架构" class="header-anchor">#</a> 实战案例：使用 Spring Security 搭建一套基于 JWT 的 OAuth 2.0 架构</h1> <p>如果你熟悉  Spring Security 的话，肯定知道它因为功能多、组件抽象程度高、配置方式多样，导致了强大且复杂的特性。也因此，Spring Security 的学习成本几乎是 Spring 家族中最高的。但不仅于此，在结合实际的复杂业务场景使用 Spring Security 时，我们还要去理解一些组件的工作原理和流程，不然需要自定义和扩展框架的时候就会手足无措。这就让使用 Spring Security 的门槛更高了。</p> <p>因此，在决定使用 Spring Security 搭建整套安全体系（授权、认证、权限、审计）之前，我们还需要考虑的是：将来我们的业务会多复杂，徒手写一套安全体系来得划算，还是使用 Spring Security 更好？这也是本课程前面并没有使用 Spring Security 来演示 OAuth 2.0 流程的原因之一。</p> <p>反过来说，如果你的应用已经使用了 Spring Security 来做鉴权、认证和权限管理的话，那么仍然使用 Spring Security 来实现 OAuth 的成本是很低的。而且，在学习了 OAuth 2.0 的流程打下扎实的基础之后，我们再使用 Spring Security 来配置 OAuth 2.0 就不会那么迷茫了。这也是我在工作中使用 Spring Security 来实现 OAuth 2.0 的直观感受。</p> <p>所以，我就结合自己的实践和积累，带你使用 Spring Security 来一步一步地搭建一套基于 JWT 的 OAuth 2.0 授权体系。这些内容会涉及 OAuth 2.0 的三角色（客户端、授权服务、受保护资源），以及资源拥有者凭据许可、客户端凭据许可和授权码许可这三种常用的授权许可类型（隐式许可类型，不太安全也不太常用）。同时，我还会演示 OAuth 2.0 的权限控制，以及使用 OAuth 2.0 实现 SSO 单点登录体系。</p> <p>这样一来，今天这一讲涉及到的流程就会比较多，内容也会很长。不过不用担心，我会手把手带你从零开始，完成整个程序的搭建，并给出所有流程的演示。</p> <h2 id="项目准备工作"><a href="#项目准备工作" class="header-anchor">#</a> 项目准备工作</h2> <p>实战之前，我们先来搭建项目父依赖和初始化数据库结构，为后面具体的编码做准备。</p> <p>首先，我们来创建一个父 POM（笔者这里使用 gradle 来搭建），内含三个模块：</p> <ul><li><p>springsecurity101-cloud-oauth2-client，用来扮演客户端角色；</p></li> <li><p>springsecurity101-cloud-oauth2-server，用来扮演授权服务器角色；</p></li> <li><p>springsecurity101-cloud-oauth2-userservice，是用户服务，用来扮演资源提供者角色。</p></li></ul> <p>然后，我们来创建一个 oauth 数据库，初始化将来会用到的 5 个表。</p> <ul><li><p>authorities 表：记录账号的权限，需要我们在后面配置。</p></li> <li><p>oauth_approvals 表：记录授权批准的状态。</p></li> <li><p>oauth_client_details 表：记录 OAuth 的客户端，需要我们在后面做配置。</p></li> <li><p>oauth_code 表：记录授权码。</p></li> <li><p>users 表：记录账号，需要我们在后面做初始化。</p></li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for authorities</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authority<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ix_auth_username<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>authority<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">CONSTRAINT</span> <span class="token identifier"><span class="token punctuation">`</span>fk_authorities_users<span class="token punctuation">`</span></span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_approvals</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clientId<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>partnerKey<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>expiresAt<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lastModifiedAt<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_client_details</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token comment">-- client_id 长度过长，255 -&gt; 128</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_code</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>code<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authentication<span class="token punctuation">`</span></span> <span class="token keyword">blob</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for users</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>enabled<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>这 5 个表是 Spring Security OAuth 需要用到的存储表，我们不要去修改既有的表结构。这里可以看到，我们并没有在数据库中创建相应的表，来存放访问令牌和刷新令牌。这是因为，我们之后的实现会使用 JWT 来传输令牌信息，以便进行本地校验，所以并不一定要将其存放到数据库中。基本上所有的这些表都是可以自己扩展的，只需要继承实现 Spring 的一些既有类即可，这里不做展开。</p> <p>接下来，我们开始搭建授权服务器和受保护资源服务器。</p> <h2 id="搭建授权服务器"><a href="#搭建授权服务器" class="header-anchor">#</a> 搭建授权服务器</h2> <p>build.gradle</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.4.1'</span>
    id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.10.RELEASE'</span>
    id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'cn.mrcode.cloudoath2.server'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    maven <span class="token punctuation">{</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ext <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">&quot;2020.0.0-RC1&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-data-jdbc'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-thymeleaf'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span>
    testImplementation <span class="token string">'org.springframework.boot:spring-boot-starter-test'</span>

    implementation <span class="token string">'mysql:mysql-connector-java'</span>
    <span class="token comment">// ~ lombok 编译等支持==========================</span>
    <span class="token function">compileOnly</span><span class="token punctuation">(</span><span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">)</span>
    <span class="token function">annotationProcessor</span><span class="token punctuation">(</span><span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token interpolation-string"><span class="token string">&quot;org.springframework.cloud:spring-cloud-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">springCloudVersion</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{</span>
    <span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>这里，我们使用了 Spring Cloud 的 spring-cloud-starter-oauth2 组件，而不是直接使用的 Spring Security，因为前者做了一些自动化配置的工作，使用起来会更方便。</p> <p>此外，我们还在 POM 中加入了数据访问、Web 等依赖，因为我们的受保护资源服务器需要使用数据库来保存客户端的信息、用户信息等数据，同时也会引入 thymeleaf 模板引擎依赖，来稍稍美化一下登录页面。</p> <p>然后创建一个配置文件 application.yml 实现程序配置：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>server
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>6657/oauth<span class="token punctuation">?</span>useSSL=false
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> kIo9u7Oi0eg
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到，我们配置了 oauth 数据库的连接字符串，定义了授权服务器的监听端口是 8080。</p> <p>最后，使用 keytool 工具生成密钥对，把密钥文件 jks 保存到资源目录下，并要导出一个公钥留作以后使用。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 运行下面的命令生成私钥，姓名国家啥的可以不填</span>
$ keytool <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-alias</span> oath2-jwt <span class="token parameter variable">-keyalg</span> RSA <span class="token parameter variable">-keysize</span> <span class="token number">1024</span> <span class="token parameter variable">-keystore</span> jwt.jks <span class="token parameter variable">-validity</span> <span class="token number">365</span> <span class="token parameter variable">-keypass</span> <span class="token number">123456</span> <span class="token parameter variable">-storepass</span> <span class="token number">123456</span>
<span class="token comment"># -alias 选项为别名，-keypass 和 -storepass 为密码选项，-validity 为配置 jks 文件的过期时间（单位：天）。</span>
<span class="token comment"># 完成之后，要求转移到新的标准</span>
$ keytool <span class="token parameter variable">-importkeystore</span> <span class="token parameter variable">-srckeystore</span> jwt.jks <span class="token parameter variable">-destkeystore</span> jwt.jks <span class="token parameter variable">-deststoretype</span> pkcs12

<span class="token comment"># 获取的 jks 文件作为私钥，是如何解密JWT的呢？这时就需要使用 jks 文件的公钥。获取jks文件的公钥命令如下：</span>
$ keytool <span class="token parameter variable">-list</span> <span class="token parameter variable">-rfc</span> <span class="token parameter variable">--keystore</span> jwt.jks <span class="token operator">|</span> openssl x509 <span class="token parameter variable">-inform</span> pem <span class="token parameter variable">-pubkey</span>
<span class="token comment"># 输入密码后：123456 ，将生产下面的</span>
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCM0iHtBw+Kbmynd34MS1g8DvcQ
hhDNacxRepPKmzMs524UX1bLeMlM6A4TE1Gp106nz5xRGPB4AVHq7BFe25H/xdT3
SpoSvfnkb9SgfPX7Y+PuNLxhGxUt8qNgzHEjsJomxEiYGsYIaxScFuGK6uXhPi4d
c4csrdiaAelTIAASRQIDAQAB
-----END PUBLIC KEY-----
-----BEGIN CERTIFICATE-----
MIICcjCCAdugAwIBAgIEG0oUDzANBgkqhkiG9w0BAQsFADBsMRAwDgYDVQQGEwdV
bmtub3duMRAwDgYDVQQIEwdVbmtub3duMRAwDgYDVQQHEwdVbmtub3duMRAwDgYD
VQQKEwdVbmtub3duMRAwDgYDVQQLEwdVbmtub3duMRAwDgYDVQQDEwdVbmtub3du
MB4XDTIwMTIxODA2MjIwMloXDTIxMTIxODA2MjIwMlowbDEQMA4GA1UEBhMHVW5r
bm93bjEQMA4GA1UECBMHVW5rbm93bjEQMA4GA1UEBxMHVW5rbm93bjEQMA4GA1UE
ChMHVW5rbm93bjEQMA4GA1UECxMHVW5rbm93bjEQMA4GA1UEAxMHVW5rbm93bjCB
nzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAjNIh7QcPim5sp3d+DEtYPA73EIYQ
zWnMUXqTypszLOduFF9Wy3jJTOgOExNRqddOp8+cURjweAFR6uwRXtuR/8XU90qa
Er355G/UoHz1+2Pj7jS8YRsVLfKjYMxxI7CaJsRImBrGCGsUnBbhiurl4T4uHXOH
LK3YmgHpUyAAEkUCAwEAAaMhMB8wHQYDVR0OBBYEFLB6k0kr0YK9fgG2qJ7fK+MQ
+984MA0GCSqGSIb3DQEBCwUAA4GBAEdv2UMAzqVDXvnIbBnP+kUafemA2rxxT+jg
9d/sVMcqrLgvGXv555U1OWGoSMKe1t3exiXvoYSaOzQUeTjyqxAXycb12N07CqB8
+XV1a+AA6vnksdB8HqfsUUAMWUnYPZPmI3FEEs2g2/PhHt1ItkH6LUAknSMqqe/t
58VPFwUO
-----END CERTIFICATE-----
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>以上完成了项目框架搭建工作，接下来，我们正式开始编码。</p> <p>第一步，创建一个最核心的类用于配置授权服务器。我把每段代码的作用放在了注释里，你可以直接看下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">NoOpPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">ClientDetailsServiceConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerConfigurerAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableAuthorizationServer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerSecurityConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>approval<span class="token punctuation">.</span></span><span class="token class-name">JdbcApprovalStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>code<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationCodeServices</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>code<span class="token punctuation">.</span></span><span class="token class-name">JdbcAuthorizationCodeServices</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancerChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtAccessTokenConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">KeyStoreKeyFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ViewControllerRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span> <span class="token comment">//开启授权服务器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

    <span class="token comment">/**
     * &lt;pre&gt;
     *  我们配置了使用数据库来维护客户端信息。虽然在各种 Demo 中我们经常看到的是在内存中维护客户端信息， 通过配置直接写死在这里。
     *
     *  但是，对于实际的应用我们一般都会用数据库来维护这个信息，甚至还会建立一套工作流来允许客户端自己申请 ClientID，实现 OAuth 客户端接入的审批。
     * &lt;/pre&gt;
     *
     * @param clients
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">jdbc</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这里干了两件事儿。
     * &lt;pre&gt;
     *   首先，打开了验证 Token 的访问权限（以便之后我们演示）。
     *   然后，允许 ClientSecret 明文方式保存，并且可以通过表单提交（而不仅仅是 BasicAuth方式提交），之后会演示到这个。
     * &lt;/pre&gt;
     *
     * @param security
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        security<span class="token punctuation">.</span><span class="token function">checkTokenAccess</span><span class="token punctuation">(</span><span class="token string">&quot;permitAll()&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">allowFormAuthenticationForClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;pre&gt;
     * 干了以下4件事儿：
     * 1. 配置我们的令牌存放方式为 JWT方式，而不是内存、数据库或 Redis方式。
     *      JWT 是 Json Web Token 的缩写，也就是使用 JSON 数据格式包装的令牌，由 .号把整个 JWT分隔为头、数据体、签名三部分。
     *      JWT保存 Token 虽然易于使用但是不是那么安全，一般用于内部，且需要走 HTTPS 并配置比较短的失效时间。
     * 2. 配置 JWT Token 的非对称加密来进行签名
     * 3. 配置一个自定义的 Token 增强器，把更多信息放入 Token 中
     * 4. 配置使用 JDBC 数据库方式来保存用户的授权批准记录
     * &lt;/pre&gt;
     *
     * @param endpoints
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endpoints<span class="token punctuation">.</span><span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 JDBC 数据库方式来保存授权码
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationCodeServices</span> <span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcAuthorizationCodeServices</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 JWT 存储
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 JDBC 数据库方式来保存用户的授权批准记录
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcApprovalStore</span> <span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcApprovalStore</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 自定义的Token增强器，把更多信息放入Token中
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenEnhancer</span> <span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置 JWT 使用非对称加密方式来验证
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 生成的 jks 文件 和 密码</span>
        <span class="token class-name">KeyStoreKeyFactory</span> keyStoreKeyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;jwt.jks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setKeyPair</span><span class="token punctuation">(</span>keyStoreKeyFactory<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;oath2-jwt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成时候的别名</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置登录页面的视图信息（其实可以独立一个配置类，这样会更规范）
     */</span>
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br></div></div><p>第二步，还记得吗，刚才在第一步的代码中我们还用到了一个自定义的 Token 增强器，把用户信息嵌入到 JWT Token 中去（如果使用的是客户端凭据许可类型，这段代码无效，因为和用户没关系）。</p> <p>这是一个常见需求。因为，默认情况下 Token 中只会有用户名这样的基本信息，我们往往需要把关于用户的更多信息返回给客户端（在实际应用中，你可能会从数据库或外部服务查询更多的用户信息加入到 JWT Token 中去）。这个时候，我们就可以自定义增强器来丰富 Token 的内容：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DefaultOAuth2AccessToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AccessToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Authentication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTokenEnhancer</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Authentication</span> userAuthentication <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userAuthentication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> principal <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//把用户标识嵌入 JWT Token 中去(Key 是 userDetails)</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            additionalInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userDetails&quot;</span><span class="token punctuation">,</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>additionalInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>第三步，实现安全方面的配置。你可以直接看下代码注释，来了解关键代码的作用。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManagerBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置用户账户的认证方式。
     * &lt;pre&gt;
     * 显然，我们把用户存在了数据库中希望配置 JDBC 的方式。
     * 此外，我们还配置了使用 BCryptPasswordEncoder 哈希来保存用户的密码（生产环境中，用户密码肯定不能是明文保存的）
     * &lt;/pre&gt;
     *
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">jdbcAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;pre&gt;
     * 开放 /login 和 /oauth/authorize 两个路径的匿名访问。
     * 前者用于登录，后者用于换授权码，这两个端点访问的时机都在登录之前。
     * 设置 /login 使用表单验证进行登录。
     *
     * &lt;/pre&gt;
     *
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/oauth/authorize&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>第四步，在资源目录下创建一个 templates 文件夹，然后创建一个 login.html 登录页：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>登录页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-height-1-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-vertical-align uk-text-center uk-height-1-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-vertical-align-middle<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 250px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Login Form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-text-danger<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${param.error}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            用户名或密码错误...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-panel uk-panel-box uk-form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/login}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-form-large<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Username<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reader<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-form-large<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Password<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reader<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-button uk-button-primary uk-button-large<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>至此，授权服务器的编码工作就完成了。</p> <h2 id="搭建受保护资源服务器"><a href="#搭建受保护资源服务器" class="header-anchor">#</a> 搭建受保护资源服务器</h2> <p>接下来，我们搭建一个用户服务模拟资源提供者（受保护资源服务器）。我们先看看项目初始化工作。</p> <p>这次创建的 POM 没有什么特殊，依赖了 spring-cloud-starter-oauth2：</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.4.1'</span>
    id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.10.RELEASE'</span>
    id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'cn.mrcode.cloudoath2.server'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    maven <span class="token punctuation">{</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ext <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">&quot;2020.0.0-RC1&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span>
<span class="token punctuation">}</span>

dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token interpolation-string"><span class="token string">&quot;org.springframework.cloud:spring-cloud-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">springCloudVersion</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{</span>
    <span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>配置文件非常简单，只是声明了资源服务端口为 8081：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同时，还要记得把我们之前在项目准备工作时生成的密钥对的公钥命名为 public.cert，并放到资源文件下。这样，资源服务器可以本地校验 JWT 的合法性。内容大概是这样的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCM0iHtBw+Kbmynd34MS1g8DvcQ
hhDNacxRepPKmzMs524UX1bLeMlM6A4TE1Gp106nz5xRGPB4AVHq7BFe25H/xdT3
SpoSvfnkb9SgfPX7Y+PuNLxhGxUt8qNgzHEjsJomxEiYGsYIaxScFuGK6uXhPi4d
c4csrdiaAelTIAASRQIDAQAB
-----END PUBLIC KEY-----
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>好了，让我们正式开始编码吧。</p> <p>第一步，创建一个可以匿名访问的接口 <code>GET /hello</code>，用来测试无需登录就可以访问的服务端资源：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>userservice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>第二步，创建三个需要登录 + 授权才能访问到的接口。我们通过 <code>@PreAuthorize</code>  在方法执行前进行权限控制：</p> <ol><li><p><code>GET /user/name</code> 接口，读权限或写权限可访问，返回登录用户名；</p></li> <li><p><code>GET /user</code> 接口，读权限或写权限可访问，返回登录用户信息；</p></li> <li><p><code>POST /user</code> 接口，只有写权限可以访问，返回访问令牌中的额外信息（也就是自定义的 Token 增强器 CustomTokenEnhancer 加入到访问令牌中的额外信息，Key 是 userDetails），这里也演示了使用 TokenStore 来解析 Token 的方式。</p></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>userservice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>prepost<span class="token punctuation">.</span></span><span class="token class-name">PreAuthorize</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AccessToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Authentication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthenticationDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token comment">/***
     * 读权限或写权限可访问，返回登录用户名
     * @param authentication
     * @return
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 读权限或写权限可访问，返回登录用户信息
     *
     * @param authentication
     * @return
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2Authentication</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 只有写权限可以访问，返回访问令牌中的额外信息
     *
     * @param authentication
     * @return
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OAuth2AuthenticationDetails</span> details <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OAuth2AuthenticationDetails</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OAuth2AccessToken</span> accessToken <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">.</span><span class="token function">getAdditionalInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token string">&quot;userDetails&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>第三步，创建核心的资源服务器配置类。这里我们需要注意下面两点：</p> <ul><li><p>我们硬编码了资源服务器的 ID 为 userservice；</p></li> <li><p>现在我们使用的是不落数据库的 JWT 方式 + 非对称加密，需要通过本地公钥进行验证，因此在这里我们配置了公钥的路径。</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>userservice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>method<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableGlobalMethodSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableResourceServer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">ResourceServerConfigurerAdapter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">ResourceServerSecurityConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtAccessTokenConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">FileCopyUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span> <span class="token comment">//启用资源服务器</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//启用方法注解方式来进行权限控制</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 声明了资源服务器的 ID 是 userservice，声明了资源服务器的 TokenStore 是 JWT
     *
     * @param resources
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span><span class="token string">&quot;userservice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置 TokenStore
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置公钥
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;public.cert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> publicKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            publicKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">FileCopyUtils</span><span class="token punctuation">.</span><span class="token function">copyToByteArray</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        converter<span class="token punctuation">.</span><span class="token function">setVerifierKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置了除了 /user 路径之外的请求可以匿名访问
     *
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/user/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>到这里，我们来想一下，如果授权服务器产生 Token 的话，受保护资源服务器必须要有一种办法来验证 Token，那如果这里的 Token 不是 JWT 的方式，我们可以怎么办呢？</p> <p>我来说下我的方法吧：</p> <ul><li><p>首先，Token 可以保存在数据库或 Redis 中，资源服务器和授权服务器共享底层的 TokenStore 来验证；</p></li> <li><p>然后，资源服务器可以使用 RemoteTokenServices，来从授权服务器的 <code>/oauth/check_token</code>  端点进行 Token 校验。</p></li></ul> <p>到这里，资源服务器就配置完成了，我们还在资源服务器中分别创建了两个控制器 HelloController 和 UserController，用于分别测试可以匿名访问以及受到权限保护的资源。</p> <h2 id="初始化数据配置"><a href="#初始化数据配置" class="header-anchor">#</a> 初始化数据配置</h2> <p>在实现了授权服务器和受保护资源服务器代码后，我们再来初始化 oauth 数据库的数据就非常容易理解了。总结起来，我们需要配置用户、权限和客户端三部分。</p> <ol><li><p>配置两个用户。</p> <ul><li>其中，读用户 reader 具有读权限，密码为 reader；</li> <li>写用户 writer 具有读写权限，密码为 writer。</li></ul> <p>还记得吗，密码我们使用的是 BCryptPasswordEncoder 加密（准确说是哈希）？</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'$2a$04$C6pPJvC1v6.enW6ZZxX.luTdpSI/1gcgTVN7LhvQV6l/AfmzNU/3i'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token string">'$2a$04$M9t2oVs3/VIreBMocOujqOaB/oziWL0SnlWdt8hV4YnlhQrORA0fS'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>配置两个权限，也就是配置 reader 用户具有读权限，writer 用户具有写权限：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'READ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>配置三个客户端：</p> <ol><li>其中客户端 userservice1 使用资源拥有者凭据许可类型</li> <li>客户端 userservice2 使用客户端凭据许可类型</li> <li>客户端 userservice3 使用授权码许可类型。</li></ol> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice1'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'password,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice2'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'client_credentials,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice3'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'authorization_code,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">'https://baidu.com,http://localhost:8082/ui/login,http://localhost:8083/ui/login,http://localhost:8082/ui/remoteCall'</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol> <p>值得说明的是：</p> <ul><li><p>三个客户端账号能使用的资源 ID 都是 userservice，对应我们受保护资源服务器刚才配置的资源 ID，也就是 userservice，这两者需要一致。</p></li> <li><p>三个客户端账号的密码都是 1234。</p></li> <li><p>三个客户端账号的授权范围都是 FOO（并不是关键信息），它们可以拿到的权限是读写。不过，对于和用户相关的授权许可类型（比如资源拥有者凭据许可、授权码许可），最终拿到的权限还取决于客户端权限和用户权限的交集。</p></li></ul> <p>通过 grant_types 字段配置支持不同的授权许可类型。这里为了便于测试观察，我们给三个客户端账号各自配置了一种授权许可类型；在实际业务场景中，你完全可以为同一个客户端配置支持 OAuth 2.0 的四种授权许可类型。</p> <p>userservice1 和 userservice2 我们配置了用户自动批准授权（不会弹出一个页面要求用户进行授权）。</p> <h2 id="演示三种授权许可类型"><a href="#演示三种授权许可类型" class="header-anchor">#</a> 演示三种授权许可类型</h2> <p>到这里，授权服务器和受保护资源服务器程序都搭建完成了，数据库也配置了用于测试的用户、权限和客户端。接下来，我们就使用 Postman 来手工测试一下 OAuth 2.0 的授权码许可、资源拥有者凭据许可、客户端凭据许可这三种授权许可类型吧。</p> <h3 id="资源拥有者凭据许可类型"><a href="#资源拥有者凭据许可类型" class="header-anchor">#</a> 资源拥有者凭据许可类型</h3> <p>首先，我们测试的是资源拥有者凭据许可，POST 请求地址是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/token?grant_type=password&amp;client_id=userservice1&amp;client_secret=1234&amp;username=writer&amp;password=writer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到的结果如下</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/token?grant_type=password&amp;client_id=userservice1&amp;client_secret=1234&amp;username=writer&amp;password=writer</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
Cache-Control<span class="token operator">:</span> no-store
Pragma<span class="token operator">:</span> no-cache
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json;charset=UTF<span class="token number">-8</span>
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">21</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoid3JpdGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI4MjAyMSwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoid3JpdGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQsV1JJVEUifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFELFdSSVRFIl0sImp0aSI6ImVjM2Y3YTY1LTA4MzQtNDQ2ZC05NDkyLWVhZjhkN2VhZjZjOCIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMSJ9.BA8vH4KN2Cx4EG0mA78VM0rNDDNrYDxcuNpa6jCT49YA7xNeWXbv3Q47nEJg_idv59EAkJdxtJfIMgX8olhik1YxwAgJcA92BlEoqY4N2jNAkgNXtvIHaa_V2Eq3m8B_KhMV2xNQFm0G2JEr0DIfSK6Lr8o_ODbu3cBfAKvy648&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoid3JpdGVyIiwic2NvcGUiOlsiRk9PIl0sImF0aSI6ImVjM2Y3YTY1LTA4MzQtNDQ2ZC05NDkyLWVhZjhkN2VhZjZjOCIsImV4cCI6MTYxMDg2NjgyMSwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoid3JpdGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQsV1JJVEUifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFELFdSSVRFIl0sImp0aSI6IjhmYTk0NTJmLTE4NTktNDg0Ni1iZGUxLThlM2ZmMmIwOGRjNSIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMSJ9.P9yxZYDEmxBWGZm0RDq6ZA9vTHXz_rPIKLICjSrTRDbe-dGprvqZaiqJfstzXt3inThnuj_CCK61nA6wOTxf1rM8rkjyBC3y9TK8a-A_DInxIjnPPnlBJWjoknyHeDC9Bh4eCK2auSV9BE1HTAMhLdpoZdkgLAPhNX0z0fgpkUk&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FOO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userDetails&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ,WRITE&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ec3f7a65-0834-446d-9492-eaf8d7eaf6c8&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>再使用 <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT 解析工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 看下请求 Token 中的信息：</p> <p><img src="/assets/img/8e4c2dd1931a31197df55cc251b2a07e.8e4c2dd1.png" alt="img"></p> <p>可以看到，Token 中果然包含了 Token 增强器加入的 userDetails 自定义信息。如果我们把公钥粘贴到页面的话，可以看到这个 JWT 校验成功了：</p> <p><img src="/assets/img/4d701319144d3de7c5d743f59e4991ae.4d701319.png" alt="img"></p> <p>除了本地校验外，还可以访问授权服务器来校验 JWT：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/check_token?client_id=userservice1&amp;client_secret=1234&amp;token=...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-json line-numbers-mode"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/check_token?client_id=userservice1&amp;client_secret=1234&amp;token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoid3JpdGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI4MjAyMSwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoid3JpdGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQsV1JJVEUifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFELFdSSVRFIl0sImp0aSI6ImVjM2Y3YTY1LTA4MzQtNDQ2ZC05NDkyLWVhZjhkN2VhZjZjOCIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMSJ9.BA8vH4KN2Cx4EG0mA78VM0rNDDNrYDxcuNpa6jCT49YA7xNeWXbv3Q47nEJg_idv59EAkJdxtJfIMgX8olhik1YxwAgJcA92BlEoqY4N2jNAkgNXtvIHaa_V2Eq3m8B_KhMV2xNQFm0G2JEr0DIfSK6Lr8o_ODbu3cBfAKvy648</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
Cache-Control<span class="token operator">:</span> no-cache<span class="token punctuation">,</span> no-store<span class="token punctuation">,</span> max-age=<span class="token number">0</span><span class="token punctuation">,</span> must-revalidate
Pragma<span class="token operator">:</span> no-cache
Expires<span class="token operator">:</span> <span class="token number">0</span>
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">55</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;userservice&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;FOO&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;active&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1608282021</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userDetails&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ,WRITE&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;READ,WRITE&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ec3f7a65-0834-446d-9492-eaf8d7eaf6c8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;client_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userservice1&quot;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="客户端授权许可类型"><a href="#客户端授权许可类型" class="header-anchor">#</a> 客户端授权许可类型</h3> <p>我们再来测试下客户端授权许可类型。POST 请求地址：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=userservice2&amp;client_secret=1234</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
Cache-Control<span class="token operator">:</span> no-store
Pragma<span class="token operator">:</span> no-cache
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json;charset=UTF<span class="token number">-8</span>
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">56</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI4MjQxNiwiYXV0aG9yaXRpZXMiOlsiUkVBRCIsIldSSVRFIl0sImp0aSI6IjI0ZjhjMGMzLWE0NTQtNGQwYy04NTAxLTQ2MjY0YjMyZTliMCIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMiJ9.H5knrswTnlEnWYfb21EGcYFenIg1gU0hNyy1RELKrQWFuBAocDA_P4OxxzCQ-I4IVxq2N4E5_ve-Oo28jzgWvpgT9LD6BX6KZkw8a2mozgy4Jh-6eLKyIrvf-kX9qaCkztcQoFrqcFloLEsJMeCO7aCXwsflli4f6VbdfltGXpk&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FOO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;24f8c0c3-a454-4d0c-8501-46264b32e9b0&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里需要注意的是，并没有提供刷新令牌。这是因为，刷新令牌用于避免访问令牌失效后需要用户再次登录的问题，而客户端授权许可类型没有用户的概念，因此没有刷新令牌，<strong>也无法注入额外的 userDetails 信息</strong>。</p> <p><img src="/assets/img/fcf2b1c1a53ecc33d3a0abc72b6d83da.fcf2b1c1.png" alt="img"></p> <p>也可以试一下，如果我们的授权服务器没有开启 <code>allowFormAuthenticationForClients</code>  参数（允许表单提交认证）的话，客户端的凭证需要通过 Basic Auth 传过去而不是通过 Post：</p> <h3 id="授权码许可类型"><a href="#授权码许可类型" class="header-anchor">#</a> 授权码许可类型</h3> <p>最后，我们来测试下比较复杂的授权码许可。</p> <p><strong>第一步</strong>，打开浏览器访问地址：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=userservice3&amp;redirect_uri=https://baidu.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意，客户端跳转地址需要和数据库中配置的一致（百度的 URL https://baidu.com 我们之前已经在数据库中有配置了）。访问后页面会直接跳转到登录界面，我们使用用户名 「reader」、密码「reader」来登录：</p> <p><img src="/assets/img/73c3bd926e4e350b220447cd8b97d811.73c3bd92.png" alt="img"></p> <p>由于我们在数据库中设置的是禁用自动批准授权的模式，所以登录后来到了批准界面：</p> <p><img src="/assets/img/9cac3b06b632220166d7e43607da4901.9cac3b06.png" alt="img"></p> <p>点击同意后可以看到，数据库中也会产生授权通过记录：</p> <p><img src="/assets/img/9e942cc7c22ff8b4540e9f6736d56b6f.9e942cc7.png" alt="img"></p> <p>**第二步，**我们可以看到浏览器转到了百度并且提供给了我们授权码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
https://www.baidu.com/?code=XKkHGY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>数据库中也记录了授权码：</p> <p><img src="/assets/img/eff235ff90aafb559d6e45b07a4d173e.eff235ff.png" alt="img"></p> <p>然后 POST 访问下面的地址（code 参数替换为刚才获得的授权码）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=userservice3&amp;client_secret=1234&amp;code=XKkHGY&amp;redirect_uri=https://baidu.com

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以通过授权码换取访问令牌：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=userservice3&amp;client_secret=1234&amp;code=A1813M&amp;redirect_uri=https%3A%2F%2Fbaidu.com</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
Cache-Control<span class="token operator">:</span> no-store
Pragma<span class="token operator">:</span> no-cache
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json;charset=UTF<span class="token number">-8</span>
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">37</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoicmVhZGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI5MDYxNywidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoicmVhZGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFEIl0sImp0aSI6ImVjNWM2NzhmLWYxNTktNGY5YS1iMGJlLWYyNjVkNDZhYjVhYyIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMyJ9.Fv1cuEJChoqZE2xjyW8tk0H8wRcyD2SkdruBrGTJB_V_FoCzFSY5_7WKHR2VTLXeiraq33B21J4S_UKzbNxFnUg1AY_dx6hXSKewXP8obZPOAxP7JUgbewJv7yNr-fQ15LZF1poLZgZp2XDvH4LeVLe-xkpG5I2a6MEE4ItUXJU&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoicmVhZGVyIiwic2NvcGUiOlsiRk9PIl0sImF0aSI6ImVjNWM2NzhmLWYxNTktNGY5YS1iMGJlLWYyNjVkNDZhYjVhYyIsImV4cCI6MTYxMDg3NTQxNywidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoicmVhZGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFEIl0sImp0aSI6IjNkZjMxMDRjLTczNTYtNGVkOS04M2ZlLTBhZTg2ZmFkNTk4MiIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMyJ9.aFxewJI1ekZEcusuOuleQoqE5byjFL5oyUvVSUzzcHkSntvgxOFFYte8kEyfVXaCMAVTdpF1r3WmprdtyQ8qxsNbWIr2SBy7YKUbECf0JVKOSQ6FEMpdzMu9Pvmvds_nT4WGpfUDVf2fFgVQtqA4VnQeZxUeEHwBu9NV_1Rsgt0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FOO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userDetails&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ec5c678f-f159-4f9a-b0be-f265d46ab5ac&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>虽然 userservice3 客户端可以有读权限和写权限，但是因为我们登录的用户 reader 只有读权限，所以最后拿到也只有读权限。</p> <h2 id="演示权限控制"><a href="#演示权限控制" class="header-anchor">#</a> 演示权限控制</h2> <p>现在我们来测试一下之前定义的两个账号，也就是读账号和写账号，看看它们的权限控制是否有效。</p> <p>首先，测试一下我们的安全配置，访问 <code>http://localhost:8081/hello</code> 端点不需要认证可以匿名访问：</p> <p><img src="/assets/img/7646fe1e6e4cc9914f79881576126459.7646fe1e.png" alt="img"></p> <p>访问 <code>http://localhost:8081/user</code> 需要身份认证：</p> <p><img src="/assets/img/3b22a89392c92187960aecd4bc3cf8f6.3b22a893.png" alt="img"></p> <p>不管以哪种模式拿到访问令牌，我们用具有读权限的访问令牌访问资源服务器的如下地址（请求头加入 <code>Authorization: Bearer XXXXXXXXXX</code>，其中 XXXXXXXXXX 代表访问令牌）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:8081/user</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
Cache-Control<span class="token operator">:</span> no-cache<span class="token punctuation">,</span> no-store<span class="token punctuation">,</span> max-age=<span class="token number">0</span><span class="token punctuation">,</span> must-revalidate
Pragma<span class="token operator">:</span> no-cache
Expires<span class="token operator">:</span> <span class="token number">0</span>
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">57</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;remoteAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sessionId&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tokenValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoicmVhZGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI5MTMwNiwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoicmVhZGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFEIl0sImp0aSI6IjQzMjhlZDViLTA3OTItNDkxZC04NTJkLWYwMWJhNGEzNGRmZSIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMyJ9.TIz5G2S-gIvgKRWWMRHAPYHB27s4uD0w6Sl9GPMj1L-LCgmiEbi-y2eBl9sW5CgS4bbC9o2zcHeuYx5BAFkaBtfe74dtOejhhCm20ql4kkrzCc352o7IP4h_udeebTIh5qD_76xCQY3Mwwt1a5ThTTJ3Wz_G94872XiYMDqAq9o&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tokenType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;decodedDetails&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;authenticated&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAuthentication&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authenticated&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;principal&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentials&quot;</span><span class="token operator">:</span> <span class="token string">&quot;N/A&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;credentials&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;principal&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth2Request&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;clientId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userservice3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;FOO&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;requestParameters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;client_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userservice3&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;resourceIds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;userservice&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;approved&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;refresh&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;redirectUri&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;responseTypes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;extensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;grantType&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;refreshTokenRequest&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;clientOnly&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>以 POST 方式访问 http://localhost:8081/user/，显然是失败的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8081</span><span class="token operator">/</span>user

<span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">403</span> 
<span class="token class-name">Cache</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">:</span> no<span class="token operator">-</span>store
<span class="token class-name">Pragma</span><span class="token operator">:</span> no<span class="token operator">-</span>cache
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> nosniff
<span class="token class-name">X</span><span class="token operator">-</span><span class="token constant">XSS</span><span class="token operator">-</span><span class="token class-name">Protection</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> mode<span class="token operator">=</span>block
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Frame</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> <span class="token constant">DENY</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json
<span class="token class-name">Transfer</span><span class="token operator">-</span><span class="token class-name">Encoding</span><span class="token operator">:</span> chunked
<span class="token class-name">Date</span><span class="token operator">:</span> <span class="token class-name">Fri</span><span class="token punctuation">,</span> <span class="token number">18</span> <span class="token class-name">Dec</span> <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">42</span> <span class="token constant">GMT</span>
<span class="token class-name">Keep</span><span class="token operator">-</span><span class="token class-name">Alive</span><span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">60</span>
<span class="token class-name">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive

<span class="token punctuation">{</span>
  <span class="token string">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;access_denied&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;error_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;不允许访问&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>因为这个接口要求有写权限：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们换一个具有读写权限的访问令牌来试试：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code># 登录页面
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>oauth<span class="token operator">/</span>authorize<span class="token operator">?</span>response_type<span class="token operator">=</span>code<span class="token operator">&amp;</span>client_id<span class="token operator">=</span>userservice3<span class="token operator">&amp;</span>redirect_uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com

用 writer<span class="token operator">/</span>writer 登录

# 换取 token
<span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>oauth<span class="token operator">/</span>token<span class="token operator">?</span>grant_type<span class="token operator">=</span>authorization_code<span class="token operator">&amp;</span>client_id<span class="token operator">=</span>userservice3<span class="token operator">&amp;</span>client_secret<span class="token operator">=</span><span class="token number">1234</span><span class="token operator">&amp;</span>code<span class="token operator">=</span><span class="token class-name">Ipbkuq</span><span class="token operator">&amp;</span>redirect_uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com

# 访问资源
<span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8081</span><span class="token operator">/</span>user

<span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> 
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> nosniff
<span class="token class-name">X</span><span class="token operator">-</span><span class="token constant">XSS</span><span class="token operator">-</span><span class="token class-name">Protection</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> mode<span class="token operator">=</span>block
<span class="token class-name">Cache</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">:</span> no<span class="token operator">-</span>cache<span class="token punctuation">,</span> no<span class="token operator">-</span>store<span class="token punctuation">,</span> max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> must<span class="token operator">-</span>revalidate
<span class="token class-name">Pragma</span><span class="token operator">:</span> no<span class="token operator">-</span>cache
<span class="token class-name">Expires</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Frame</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> <span class="token constant">DENY</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json
<span class="token class-name">Transfer</span><span class="token operator">-</span><span class="token class-name">Encoding</span><span class="token operator">:</span> chunked
<span class="token class-name">Date</span><span class="token operator">:</span> <span class="token class-name">Fri</span><span class="token punctuation">,</span> <span class="token number">18</span> <span class="token class-name">Dec</span> <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">34</span> <span class="token constant">GMT</span>
<span class="token class-name">Keep</span><span class="token operator">-</span><span class="token class-name">Alive</span><span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">60</span>
<span class="token class-name">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive

<span class="token punctuation">{</span>
  <span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ,WRITE&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="搭建客户端程序"><a href="#搭建客户端程序" class="header-anchor">#</a> 搭建客户端程序</h2> <p>在上面的演示中，我们使用的是 Postman，也就是手动 HTTP 请求的方式来申请和使用 Token。最后，我们来搭建一个 OAuth 客户端程序自动实现这个过程。</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.4.1'</span>
    id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.10.RELEASE'</span>
    id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'cn.mrcode.cloudoath2.client'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    maven <span class="token punctuation">{</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ext <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">&quot;2020.0.0-RC1&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-thymeleaf'</span>
<span class="token punctuation">}</span>

dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token interpolation-string"><span class="token string">&quot;org.springframework.cloud:spring-cloud-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">springCloudVersion</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{</span>
    <span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>配置文件如下：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /ui
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
      <span class="token key atrule">clientId</span><span class="token punctuation">:</span> userservice3
      <span class="token key atrule">clientSecret</span><span class="token punctuation">:</span> <span class="token number">1234</span>
      <span class="token key atrule">accessTokenUri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/oauth/token
      <span class="token key atrule">userAuthorizationUri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/oauth/authorize
      <span class="token key atrule">scope</span><span class="token punctuation">:</span> FOO
    <span class="token key atrule">resource</span><span class="token punctuation">:</span>
      <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
        <span class="token key atrule">key-value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          -----BEGIN PUBLIC KEY-----
          MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCM0iHtBw+Kbmynd34MS1g8DvcQ
          hhDNacxRepPKmzMs524UX1bLeMlM6A4TE1Gp106nz5xRGPB4AVHq7BFe25H/xdT3
          SpoSvfnkb9SgfPX7Y+PuNLxhGxUt8qNgzHEjsJomxEiYGsYIaxScFuGK6uXhPi4d
          c4csrdiaAelTIAASRQIDAQAB
          -----END PUBLIC KEY-----</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token comment">#logging:</span>
<span class="token comment">#  level:</span>
<span class="token comment">#    ROOT: DEBUG</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>客户端项目端口 8082，几个需要说明的地方：</p> <ol><li><p>本地测试的时候有一个坑，也就是我们需要配置 context-path，否则可能会出现客户端和授权服务器服务端 Cookie 干扰，导致 CSRF 防御触发的问题。这个问题出现后程序没有任何错误日志输出，只有开启 DEBUG 模式后才能看到 DEBUG 日志里有提示，因此这个问题非常难以排查。说实话，我也不知道 Spring 为什么不把这个信息作为 WARN 级别的日志输出。</p></li> <li><p>作为 OAuth 客户端，我们需要配置 OAuth 服务端获取 Token 的地址、授权（获取授权码）的地址，需要配置客户端的 ID、密码和授权范围。</p></li> <li><p>因为使用的是 JWT Token，我们需要配置公钥（当然，如果不在这里直接配置公钥的话，也可以配置从授权服务器服务端获取公钥）。</p></li></ol> <p>接下来，我们可以开始编码了。</p> <p>第一步，实现 MVC 的配置：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableWebMvc</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ViewControllerRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebMvc</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 配置 RequestContextListener 用于启用 session scope 的 Bean
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestContextListener</span> <span class="token function">requestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置 index 路径的首页 Controller
     *
     * @param registry
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;forward:/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>这里做了两件事情：</p> <ol><li><p>配置 RequestContextListener，用于启用 session scope 的 Bean；</p></li> <li><p>配置了 index 路径的首页 Controller。</p></li></ol> <p>第二步，实现安全方面的配置：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * / 路径和 /login 路径允许访问，其它路径需要身份认证后才能访问
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/login**&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这里我们实现的是 <code>/</code>  路径和  <code>/login</code>  路径允许访问，其它路径需要身份认证后才能访问。</p> <p>第三步，我们来创建一个控制器：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">OAuth2RestTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Authentication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OAuth2RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    <span class="token comment">// 演示登录后才能访问的安全页面</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/securedPage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">securedPage</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;securedPage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;authentication&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 演示通过 OAuth2RestTemplate 调用受保护资源</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/remoteCall&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">remoteCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseEntity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8081/user/name&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> responseEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里我们实现了两个功能：</p> <ol><li><p>securedPage 页面，实现的功能是，把用户信息作为模型传入了视图，这样打开页面后就能显示用户名和权限。</p></li> <li><p>remoteCall 接口，实现的功能是，通过引入 OAuth2RestTemplate，在登录后就可以使用凭据直接从受保护资源服务器拿资源，不需要繁琐地实现获得访问令牌、在请求头里加入访问令牌的过程。</p></li></ol> <p>第四步，配置一下刚才用到的 OAuth2RestTemplate Bean，并启用 OAuth2Sso 功能：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableOAuth2Sso</span> <span class="token comment">//这个注解包含了 @EnableOAuth2Client</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuthClientConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 定义了 OAuth2RestTemplate，网上一些比较老的资料给出的是手动读取配置文件来实现，
     * 最新版本已经可以自动注入 OAuth2ProtectedResourceDetails
     * @param oAuth2ClientContext
     * @param details
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2RestTemplate</span> <span class="token function">oauth2RestTemplate</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientContext</span> oAuth2ClientContext<span class="token punctuation">,</span>
                                                 <span class="token class-name">OAuth2ProtectedResourceDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2RestTemplate</span><span class="token punctuation">(</span>details<span class="token punctuation">,</span> oAuth2ClientContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>第五步，实现首页：index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Spring Security SSO Client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>securedPage<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>以及登录后才能访问的 securedPage 页面：securedPage.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Secured Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        Welcome, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${authentication.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
        Your authorities are <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${authentication.authorities}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>authorities<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="演示单点登录"><a href="#演示单点登录" class="header-anchor">#</a> 演示单点登录</h2> <p>好，客户端程序搭建好之后，我们先来测试一下单点登录的功能。启动客户端项目，打开浏览器访问：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8082/ui/securedPage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到，页面自动转到了授权服务器（8080 端口）的登录页面：</p> <p><img src="/assets/img/05b76f316304e3ef2d1494bae501c381.05b76f31.png" alt="img"></p> <p>登录后显示了当前用户名和权限：</p> <p><img src="/assets/img/7d24bc73267506c15f9feyy546557237.7d24bc73.png" alt="img"></p> <p>我们再启动另一个客户端网站，端口改为 8083，然后访问同样的地址：</p> <p><img src="/assets/img/7a50619ace3e40c8ff7c0aa860f11246.7a50619a.png" alt="img"></p> <p>可以看到直接是登录状态，单点登录测试成功。是不是很方便？其实，为了达成单点登录的效果，程序在背后自动实现了多次 302 重定向，整个流程为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8083/ui/securedPage -&gt;
http://localhost:8083/ui/login -&gt;
http://localhost:8080/oauth/authorize?client_id=userservice3&amp;redirect_uri=http://localhost:8083/ui/login&amp;response_type=code&amp;scope=FOO&amp;state=Sobjqe -&gt;
http://localhost:8083/ui/login?code=CDdvHa&amp;state=Sobjqe -&gt;
http://localhost:8083/ui/securedPage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="演示客户端请求资源服务器资源"><a href="#演示客户端请求资源服务器资源" class="header-anchor">#</a> 演示客户端请求资源服务器资源</h2> <p>还记得吗，在上一节「搭建客户端程序」中，我们还定义了一个 remoteCall 接口，直接使用 OAuth2RestTemplate 来访问远程资源服务器的资源。现在，我们来测试一下这个接口是否可以实现自动的 OAuth 流程。访问：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
http://localhost:8082/ui/remoteCall
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>会先转到授权服务器登录，登录后自动跳转回来：</p> <p><img src="/assets/img/016f28b7161d2c600197aa2392b0de27.016f28b7.png" alt="img"></p> <p>可以看到输出了用户名，对应的资源服务器服务端接口是：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>换一个 writer 用户登录试试，也能得到正确的输出：</p> <p><img src="/assets/img/yy2bca66c45cefa56d2d727c3a136a84.ad2bca66.png" alt="img"></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>今天这一讲，我们完整演示了如何使用 Spring Cloud 的 OAuth 2.0 组件基于三个程序角色（授权服务器、受保护资源服务器和客户端）实现三种 OAuth 2.0 的授权许可类型（资源拥有者凭据许可、客户端凭据许可和授权码许可）。</p> <p>我们先演示了三种授权许可类型的手动流程，然后也演示了如何实现权限控制和单点登录，以及如何使用客户端程序来实现自动的 OAuth 2.0 流程。</p> <p>我把今天用到的所有代码都放到了 <a href="https://github.com/zq99299/myoath2-demo" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上，你可以点击这个链接查看。</p> <p>最后，我再提一下，将来 Spring 对于 OAuth 2.0 的支持可能会转移到由社区推进的 Spring Authorization Server 项目上来继续运作。如果你感兴趣的话，可以及时关注这个项目的进展。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/luckmaosh/luckmaosh.github.io/edit/master/docs/oath2/02/05.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023-04-27 11:16:17</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/oath2/02/04.html" class="prev">
        串讲：OAuth 2.0 的工作流程与安全问题
      </a></span> <span class="next"><a href="/oath2/02/06.html">
        架构案例：基于 OAuth 2.0/JWT 的微服务参考架构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.eb56791c.js" defer></script><script src="/assets/js/10.7dba176e.js" defer></script><script src="/assets/js/22.2be2201a.js" defer></script><script src="/assets/js/104.257f0ce6.js" defer></script>
  </body>
</html>
